# 上班族小工具 — 正式上線部署方案

本文說明如何將本應用部署到正式伺服器與自有域名，供用戶穩定使用。

---

## 一、部署方式對比

| 方式 | 優點 | 缺點 | 適合 |
|------|------|------|------|
| **Streamlit Community Cloud** | 免費、一鍵部署、內建 HTTPS | 子網域、冷啟動、資源限制 | 小流量、快速上線 |
| **VPS + Docker + Nginx** | 自有域名、完全掌控、可擴展 | 需自管伺服器與維運 | **正式對外服務、推薦** |
| **PaaS（Railway / Render / Fly.io）** | 易部署、可綁域名 | 付費、依平台限制 | 中等流量、不想管伺服器 |

**建議**：若要「正式上線給用戶使用」且希望自有域名與穩定服務，優先考慮 **VPS + Docker + Nginx**；若先試水溫或內部使用，可先用 **Streamlit Community Cloud**。

---

## 二、方案 A：Streamlit Community Cloud（快速上線）

### 2.1 適用情境
- 先上線驗證、小流量或內部使用
- 可接受 `xxx.streamlit.app` 子網域（或後續用 Cloudflare 綁自訂域名）

### 2.2 步驟摘要
1. 程式推送到 **GitHub** 公開或私有倉庫。
2. 登入 [share.streamlit.io](https://share.streamlit.io) → **New app** → 選倉庫、分支、`app.py`。
3. 在 App 的 **Settings → Secrets** 貼上 TOML（見下方 Secrets 範例）。
4. 部署完成後網址為：`https://你的app名.streamlit.app`。
5. （可選）用 **Cloudflare** 做 CNAME 將自有域名指到該網址，並在 Streamlit 後台填寫對應的 Redirect URI（若用 Google/LINE 登入）。

### 2.3 注意事項
- 免費方案有資源與冷啟動限制；長時間無訪問會休眠。
- 資料庫與 `invoice_images` 在重啟後可能清空，重要資料需外接持久化（見下方「資料持久化」）。

### 2.4 為什麼會休眠？休眠後為什麼資料全沒了、刷新就跳出登入？

**原因說明：**

1. **休眠**：Streamlit Community Cloud 免費版在**一段時間無人訪問**後會把應用關掉（省資源），下次有人打開網址時再重新啟動。這是平台限制，無法關閉。
2. **資料全沒了**：應用跑在**臨時容器**裡，關掉後整個環境（包含硬碟）都會被清空。所以本機的 SQLite 資料庫、上傳的圖片、註冊的帳號，在休眠重啟後都會消失。
3. **刷新就跳出登入**：登入狀態存在「當次連線的記憶體」裡，應用一重啟或你一重新整理，連線可能換到新的一台機器或新的一次啟動，所以會要求重新登入；若資料庫已被清空，之前註冊的帳號也不存在了。

**總結**：在方案 A 免費版上，**無法避免休眠**，也**無法在應用本機持久保存資料**。要讓註冊與發票資料長期保留，必須改用下面兩種方式之一。

### 2.5 方案 A 若要資料持久化，該怎麼做？

| 做法 | 說明 |
|------|------|
| **改用法案 B（VPS）** | 在自己的伺服器上跑 Docker，資料寫在掛載的磁碟上，不會因「休眠」清空。**正式給用戶用、建議做法。** |
| **綁定外部資料庫（進階）** | 在 Secrets 設定 `DATABASE_URL`（例如 Supabase 免費 PostgreSQL），讓應用把使用者與發票寫到雲端資料庫，而不是本機 SQLite。應用重啟後仍可讀到同一份資料。目前需自行在後台建立對應表結構並在程式內支援 PostgreSQL（或未來版本提供開箱即用）。 |

若你**繼續只用方案 A 且不綁外部資料庫**，請當成「展示／試用」環境，並在登入頁提示用戶：「此為免費雲端環境，休眠後資料會清空，請改用 VPS 部署以長期保存資料。」

---

## 三、方案 B：VPS + Docker + Nginx（正式服務、推薦）

### 3.1 架構示意

```
用戶 → 域名 (https://your-domain.com)
         ↓
      Nginx (80/443, SSL)
         ↓
      Streamlit 容器 (8501)
         ↓
      資料卷：SQLite、invoice_images、.streamlit/secrets
```

### 3.2 前置準備

- **VPS**：任一雲端（阿里雲、騰訊雲、AWS、GCP、DigitalOcean、Vultr 等），建議至少 1 核 2GB，系統 Ubuntu 22.04 LTS。
- **域名**：已購買並可設定 DNS（A 記錄或 CNAME）。
- **本機**：已安裝 Git、可 SSH 登入 VPS。

### 3.3 伺服器環境（VPS 上執行）

```bash
# 1. 更新系統並安裝 Docker、Docker Compose、Nginx
sudo apt update && sudo apt upgrade -y
sudo apt install -y docker.io docker-compose-v2 nginx certbot python3-certbot-nginx

# 2. 將當前用戶加入 docker 組
sudo usermod -aG docker $USER
# 登出再登入後生效
```

### 3.4 部署專案到伺服器

```bash
# 在伺服器上（或本機透過 SSH）
cd /opt   # 或你選擇的目錄
sudo git clone https://github.com/你的用戶名/streamlit_ocr_app.git
cd streamlit_ocr_app
```

### 3.5 生產用環境變數與 Secrets

- 在伺服器上**不要**把真實密碼、API Key 寫進程式碼。
- 使用 **Docker 環境變數** 或 **檔案掛載** 提供 Secrets。

**方式 1：使用 `.env` 檔（僅限伺服器本機，勿提交 Git）**

在專案目錄建立 `.env`：

```bash
# /opt/streamlit_ocr_app/.env（範例，請替換為真實值）
GEMINI_API_KEY=你的Gemini金鑰
# 若用頂層變數做 OAuth（可選）：
# GOOGLE_CLIENT_ID=...
# GOOGLE_CLIENT_SECRET=...
# LINE_CHANNEL_ID=...
# LINE_CHANNEL_SECRET=...
```

**方式 2：使用 `.streamlit/secrets.toml`（掛載進容器）**

在伺服器上建立目錄並寫入（勿提交 Git）：

```bash
mkdir -p .streamlit
nano .streamlit/secrets.toml
```

內容範例（與你目前格式一致）：

```toml
# Gemini
GEMINI_API_KEY = "你的金鑰"

# Google 登入
[google_auth]
client_id = "你的 Google Client ID"
client_secret = "你的 Google Client Secret"
redirect_uri = "https://你的域名/"

# LINE 登入
[line_auth]
channel_id = "你的 Channel ID"
channel_secret = "你的 Channel Secret"
callback_url = "https://你的域名/"
```

### 3.6 生產用 Docker Compose

在專案目錄建立或覆寫 `docker-compose.prod.yml`（見下方「附錄」），重點：

- 掛載 **資料卷**：SQLite 資料庫、`invoice_images`、`.streamlit`（含 secrets）。
- 使用 **環境變數** 或 **secrets 檔案**，不寫死密碼。
- **restart: unless-stopped**，方便重啟後自動恢復。

### 3.7 啟動應用

```bash
cd /opt/streamlit_ocr_app
docker compose -f docker-compose.prod.yml up -d --build
# 檢查日誌
docker compose -f docker-compose.prod.yml logs -f
```

確認本機可訪問：`curl http://localhost:8501/_stcore/health` 回傳 200。

### 3.8 Nginx 反向代理與 SSL

1. **先將域名 A 記錄指到 VPS IP**，等 DNS 生效（數分鐘到數小時）。

2. **新增 Nginx 站點**（範例域名改為你的）：

```bash
sudo nano /etc/nginx/sites-available/streamlit-ocr
```

內容：

```nginx
server {
    listen 80;
    server_name 你的域名.com www.你的域名.com;

    location / {
        proxy_pass http://127.0.0.1:8501;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
```

3. **啟用站點並申請 SSL**：

```bash
sudo ln -s /etc/nginx/sites-available/streamlit-ocr /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
sudo certbot --nginx -d 你的域名.com -d www.你的域名.com
```

4. **Google / LINE OAuth**：在 Google Cloud Console、LINE Developers 後台，將「授權重導 URI」設為 `https://你的域名.com/`（與 `redirect_uri` / `callback_url` 一致）。

### 3.9 防火牆

```bash
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

---

## 四、資料持久化與備份

- **SQLite**：放在掛載卷（如 `/opt/streamlit_ocr_app/data`），避免容器重建後遺失。
- **invoice_images**：同上，掛載到固定目錄。
- **備份**：建議每日 cron 備份資料庫與重要目錄到另一台機器或對象存儲。

```bash
# 範例：每日 2:00 備份
0 2 * * * tar -czf /backup/invoice-app-$(date +\%Y\%m\%d).tar.gz /opt/streamlit_ocr_app/data /opt/streamlit_ocr_app/invoice_images
```

---

## 五、安全檢查清單

- [ ] 所有 API 金鑰、OAuth 密鑰僅放在環境變數或 `.streamlit/secrets.toml`，且不提交 Git。
- [ ] `.env`、`secrets.toml`、`*.db` 已在 `.gitignore`。
- [ ] 使用 HTTPS（Nginx + Certbot）。
- [ ] VPS 僅開放 22/80/443，關閉不必要的埠。
- [ ] 資料庫與上傳目錄權限僅限應用與備份帳號。
- [ ] 若對外開放註冊，建議啟用邀請碼（你專案已有 INVITATION_CODE 邏輯）。
- [ ] 定期更新系統與 Docker 映像。

---

## 六、上線後維運建議

- **日誌**：`docker compose logs -f` 或將日誌集中到檔案/日誌服務。
- **監控**：可對 Nginx 或 Streamlit 健康檢查 URL 做簡單監控（如 Uptime Robot）。
- **更新**：在伺服器上 `git pull` 後執行 `docker compose -f docker-compose.prod.yml up -d --build` 即可重新建置並上線。

---

## 七、附錄

### 7.1 生產用 docker-compose 範例（`docker-compose.prod.yml`）

```yaml
version: '3.8'

services:
  invoice-ocr-app:
    build: .
    image: invoice-ocr-app:latest
    container_name: invoice-ocr-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:8501:8501"   # 僅本機，由 Nginx 對外
    env_file:
      - .env
    volumes:
      - ./data:/app/data
      - ./invoice_images:/app/invoice_images
      - ./.streamlit/secrets.toml:/app/.streamlit/secrets.toml:ro
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

- 若無 `.env`，可刪除 `env_file`，改為僅依賴掛載的 `secrets.toml`。
- 需一併複製 `templates/`、`pages/`、`NotoSansTC-Regular.ttf` 等進映像（Dockerfile 已包含所需檔案即可）。

### 7.2 Dockerfile 生產建議

- 目前 Dockerfile 已暴露 8501、使用 `--server.address=0.0.0.0`，在 Nginx 後方沒問題。
- 若需在映像內包含 `templates`、`pages`，請在 Dockerfile 中增加：

```dockerfile
COPY templates/ ./templates/
COPY pages/ ./pages/
```

並確保 `app.py` 與靜態資源路徑一致。

### 7.3 PDF 萬能轉換工具（部署相容）

- **pdf2docx**（PDF→Word）：純 pip 依賴，無額外系統套件，Docker 部署即用。
- **pdf2image**（PDF→圖片、PPT）：需 `poppler-utils`，Dockerfile 已含：`apt-get install poppler-utils`。
- **預設以 pdf2docx 轉 Word**（無 API 成本）；AI OCR 為選用，僅在掃描檔轉換為空時使用。

Dockerfile 需複製 `pdf_converter.py`，並安裝 `poppler-utils`，方可完整支援 PDF 轉換功能。

---

以上完成後，用戶即可透過 **https://你的域名.com** 正式使用本服務。若你提供目前偏好的環境（例如只用 Streamlit Cloud，或已有 VPS 廠商），可再細化為一步步操作清單（含你實際域名與路徑）。
