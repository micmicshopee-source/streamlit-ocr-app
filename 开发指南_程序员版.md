# 开发指南 - 程序员版
## 發票報帳小秘笈 Pro - 功能改进与反馈系统实现

**文档版本**: v1.0  
**创建日期**: 2026-01-26  
**产品经理**: AI Assistant  
**目标版本**: v1.3

---

## 📋 任务清单

### ✅ 已完成的功能
1. ✅ 注册后自动登录
2. ✅ 删除确认对话框
3. ✅ 存储模式切换警告
4. ✅ 反馈系统数据库表
5. ✅ 反馈提交功能
6. ✅ 反馈列表显示
7. ✅ 评论功能
8. ✅ 点赞功能

---

## 🔧 实现细节说明

### 1. 注册后自动登录 ✅

**修改位置**: `app.py` 第 640-645 行

**修改前**:
```python
if success:
    st.success(f"✅ {message}")
    st.info("💡 請切換到「登入」模式使用新帳號登入")
    time.sleep(1)
    st.session_state.login_mode = "登入"
    st.rerun()
```

**修改后**:
```python
if success:
    # 註冊成功後自動登錄（提升用戶體驗）
    st.session_state.authenticated = True
    st.session_state.user_email = email.strip()
    st.success(f"✅ {message}")
    time.sleep(0.5)
    st.rerun()  # 直接跳轉到主界面
```

**关键点**:
- 注册成功后立即设置 `authenticated = True` 和 `user_email`
- 移除提示信息，直接跳转
- 缩短等待时间（0.5秒）

---

### 2. 删除确认对话框 ✅

**修改位置**: `app.py` 第 2302-2378 行

**实现逻辑**:
1. 使用 `st.session_state.show_delete_confirm` 管理确认状态
2. 点击删除按钮时，设置确认状态并保存要删除的ID列表
3. 显示确认对话框，用户确认后才执行删除
4. 取消时清除确认状态

**关键代码结构**:
```python
# 删除确认对话框（优先显示）
if st.session_state.get("show_delete_confirm", False):
    # 显示确认对话框
    # 确认/取消按钮
else:
    # 显示删除按钮
    if st.button("🗑️ 刪除選中數據"):
        # 设置确认状态
        st.session_state.show_delete_confirm = True
        st.session_state.delete_ids = ids
        st.session_state.delete_count = len(ids)
        st.rerun()
```

**注意事项**:
- 使用 `st.rerun()` 刷新页面以显示确认对话框
- 确认和取消按钮使用不同的 key，避免冲突
- 删除成功后清除所有相关 session_state

---

### 3. 存储模式切换警告 ✅

**修改位置**: `app.py` 第 1222-1295 行

**实现逻辑**:
1. 检测模式是否改变
2. 如果改变，显示警告对话框
3. 用户确认后才执行切换
4. 取消时恢复原模式

**关键代码**:
```python
current_mode = "🧠 內存模式（測試用）" if st.session_state.use_memory_mode else "🗄️ 數據庫模式"
new_mode = "🧠 內存模式（測試用）" if storage_mode == "🧠 內存模式（測試用）" else "🗄️ 數據庫模式"

if new_mode != current_mode:
    # 显示警告和确认按钮
    if st.button("✅ 確認切換"):
        # 执行切换
    if st.button("❌ 取消"):
        # 取消切换
```

**注意事项**:
- 使用 `st.session_state.storage_mode_changed` 管理警告状态
- 警告信息要清晰说明切换的后果
- 取消时恢复原模式选择

---

### 4. 反馈系统数据库设计 ✅

**修改位置**: `app.py` 第 707-743 行（`init_db()` 函数）

**新增表**:

1. **feedback 表**:
```sql
CREATE TABLE IF NOT EXISTS feedback (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_email TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    type TEXT NOT NULL,  -- 'bug', 'suggestion', 'other'
    is_anonymous INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
)
```

2. **feedback_comments 表**:
```sql
CREATE TABLE IF NOT EXISTS feedback_comments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    feedback_id INTEGER NOT NULL,
    user_email TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (feedback_id) REFERENCES feedback(id) ON DELETE CASCADE
)
```

3. **feedback_likes 表**:
```sql
CREATE TABLE IF NOT EXISTS feedback_likes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    feedback_id INTEGER NOT NULL,
    user_email TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(feedback_id, user_email),
    FOREIGN KEY (feedback_id) REFERENCES feedback(id) ON DELETE CASCADE
)
```

**索引**:
- `idx_feedback_created`: 按创建时间排序
- `idx_feedback_type`: 按类型筛选
- `idx_comments_feedback`: 快速查询评论
- `idx_likes_feedback`: 快速查询点赞

---

### 5. 反馈系统核心函数 ✅

**位置**: `app.py` 第 2333-2450 行

#### 5.1 `submit_feedback()` - 提交反馈
```python
def submit_feedback(title, content, feedback_type, is_anonymous=False):
    # 检查登录状态
    # 验证输入
    # 插入数据库
    # 返回结果
```

#### 5.2 `add_comment()` - 添加评论
```python
def add_comment(feedback_id, content):
    # 检查登录状态
    # 验证输入
    # 插入评论
    # 返回结果
```

#### 5.3 `toggle_like()` - 切换点赞
```python
def toggle_like(feedback_id):
    # 检查是否已点赞
    # 如果已点赞，取消点赞
    # 如果未点赞，添加点赞
    # 返回结果
```

#### 5.4 `get_feedback_list()` - 获取反馈列表
```python
def get_feedback_list(filter_type=None, limit=50):
    # 查询反馈列表
    # 获取每个反馈的评论数和点赞数
    # 返回 DataFrame
```

#### 5.5 `get_feedback_comments()` - 获取评论列表
```python
def get_feedback_comments(feedback_id):
    # 查询指定反馈的所有评论
    # 按时间正序排列
    # 返回 DataFrame
```

#### 5.6 `is_liked()` - 检查是否已点赞
```python
def is_liked(feedback_id):
    # 检查当前用户是否已点赞该反馈
    # 返回 True/False
```

---

### 6. 反馈系统UI实现 ✅

**位置**: `app.py` 第 2452-2600 行

**界面结构**:
1. **顶部操作栏**:
   - 类型筛选下拉框
   - "提交反馈"按钮
   - "关闭"按钮

2. **提交反馈区域**:
   - 使用 `st.expander` 展开/收起
   - 标题输入框
   - 内容文本域
   - 类型单选按钮
   - 匿名复选框
   - 提交/取消按钮

3. **反馈列表**:
   - 使用 `st.container()` 创建卡片
   - 显示标题、类型、提交者、时间
   - 点赞按钮（显示点赞数）
   - 评论区域（使用 `st.expander`）
   - 评论列表
   - 添加评论输入框

**关键UI组件**:
- `st.expander`: 用于展开/收起评论区域
- `st.container`: 用于创建反馈卡片
- `st.columns`: 用于布局（点赞按钮、评论按钮等）

---

### 7. 侧边栏反馈按钮 ✅

**位置**: `app.py` 第 1295-1298 行

**实现**:
```python
st.divider()

# 反饋意見按鈕
if st.button("💬 反饋意見", use_container_width=True, type="primary"):
    st.session_state.show_feedback_page = True
    st.rerun()
```

**功能**:
- 点击按钮后设置 `show_feedback_page = True`
- 页面刷新后显示反馈系统界面

---

## 🐛 已知问题和注意事项

### 1. 删除确认逻辑
- ✅ 已实现，使用 session_state 管理状态
- ⚠️ 注意：删除按钮和确认对话框不能同时显示，需要条件判断

### 2. 存储模式切换
- ✅ 已实现警告机制
- ⚠️ 注意：Streamlit 的 radio 组件会立即触发值改变，需要检测变化

### 3. 反馈系统
- ✅ 所有功能已实现
- ⚠️ 注意：反馈系统是公共的，所有用户都可以看到（不需要用户隔离）
- ⚠️ 注意：点赞使用 UNIQUE 约束防止重复，但需要处理插入错误

---

## 📝 代码检查清单

### 数据库
- [x] feedback 表已创建
- [x] feedback_comments 表已创建
- [x] feedback_likes 表已创建
- [x] 所有索引已创建
- [x] 外键约束已设置

### 功能函数
- [x] submit_feedback() 已实现
- [x] add_comment() 已实现
- [x] toggle_like() 已实现
- [x] get_feedback_list() 已实现
- [x] get_feedback_comments() 已实现
- [x] is_liked() 已实现

### UI组件
- [x] 反馈按钮已添加到侧边栏
- [x] 反馈列表页面已实现
- [x] 提交反馈对话框已实现
- [x] 评论功能已实现
- [x] 点赞功能已实现

### 用户体验改进
- [x] 注册后自动登录
- [x] 删除确认对话框
- [x] 存储模式切换警告

---

## 🧪 测试建议

### 功能测试
1. ✅ 测试注册后是否自动登录
2. ✅ 测试删除确认对话框是否正常显示
3. ✅ 测试存储模式切换警告是否正常
4. ✅ 测试反馈提交功能
5. ✅ 测试评论功能
6. ✅ 测试点赞功能（包括重复点赞）

### 边界情况测试
1. 未登录用户尝试提交反馈（应被阻止）
2. 空标题/空内容提交反馈（应被阻止）
3. 重复点赞（应只点赞一次）
4. 大量反馈时的性能（考虑分页）

---

## 🚀 部署注意事项

1. **数据库迁移**: 新表会自动创建，无需手动迁移
2. **向后兼容**: 所有修改都向后兼容，不影响现有数据
3. **性能考虑**: 反馈系统查询使用了索引，性能良好
4. **安全考虑**: 所有操作都检查登录状态

---

## 📊 功能完成度

| 功能 | 状态 | 备注 |
|------|------|------|
| 注册后自动登录 | ✅ | 完成 |
| 删除确认 | ✅ | 完成 |
| 存储模式警告 | ✅ | 完成 |
| 反馈系统 | ✅ | 完成 |
| 评论功能 | ✅ | 完成 |
| 点赞功能 | ✅ | 完成 |

**总体完成度**: 100% ✅

---

**文档状态**: ✅ 开发完成  
**代码状态**: ✅ 已实现  
**测试状态**: ⏳ 待测试
