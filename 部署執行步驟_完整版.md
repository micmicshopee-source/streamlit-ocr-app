# 部署執行步驟（完整版）

**日期**: 2026-01-26  
**應用**: Streamlit OCR 發票識別系統  
**狀態**: 🚀 準備部署

---

## 📋 部署前準備

### ✅ 已完成檢查
- [x] requirements.txt 已更新（包含 fpdf2, pandas 等）
- [x] API Key 安全性檢查通過（使用 st.secrets）
- [x] 代碼已清理測試內容
- [x] .gitignore 已配置（保護敏感文件）

### ⏳ 需要執行
- [ ] 推送代碼到 GitHub
- [ ] 在 Streamlit Cloud 部署
- [ ] 配置 API Key
- [ ] 驗證部署

---

## 🚀 第一步：推送代碼到 GitHub

### 方法一：使用腳本（推薦）

#### Windows 批處理腳本
1. 在文件資源管理器中找到 `git_push.bat`
2. **雙擊運行**
3. 等待執行完成

#### PowerShell 腳本
```powershell
cd d:\streamlit_ocr_app
.\git_push.ps1
```

---

### 方法二：手動執行（如果腳本失敗）

#### 步驟 1: 打開終端機
- 按 `Win + X`，選擇 "Windows PowerShell" 或 "終端機"

#### 步驟 2: 進入項目目錄
```powershell
cd d:\streamlit_ocr_app
```

#### 步驟 3: 刪除鎖定文件（如果存在）
```powershell
Remove-Item .git\index.lock -ErrorAction SilentlyContinue
```

#### 步驟 4: 添加文件
```powershell
# 添加關鍵文件
git add app.py
git add requirements.txt
git add .gitignore
git add Dockerfile
git add docker-compose.yml

# 添加部署文檔（可選）
git add "部署快速開始.md"
git add "立即部署指南.md"
git add "部署前檢查報告_20260126.md"
```

#### 步驟 5: 提交更改
```powershell
git commit -m "Update: 增加多用戶隔離、登錄註冊功能與 PDF 導出優化"
```

#### 步驟 6: 推送到遠程倉庫
```powershell
git push origin main
```

**如果遇到權限問題**:
1. 關閉 VS Code 和其他可能使用 Git 的程序
2. 以管理員身份運行 PowerShell
3. 重試上述命令

---

## 🌐 第二步：在 Streamlit Cloud 部署

### 步驟 1: 訪問 Streamlit Cloud

1. **打開瀏覽器**，訪問：
   ```
   https://share.streamlit.io
   ```

2. **登錄**
   - 點擊 "Sign in"
   - 選擇 "Continue with GitHub"
   - 授權 Streamlit 訪問您的 GitHub 帳號

---

### 步驟 2: 創建新應用

1. **點擊 "New app"** 按鈕
   - 位於頁面右上角或主頁面

2. **選擇倉庫**
   - 在下拉菜單中選擇您的 GitHub 倉庫
   - 如果沒有看到，確保已授權 Streamlit 訪問該倉庫

3. **配置應用設置**
   - **Main file path**: `app.py`
   - **Branch**: `main`（或您的主分支名稱）
   - **App URL**: （可選）自定義 URL，例如：`invoice-ocr-app`

4. **點擊 "Deploy"**（先不要點擊，繼續下一步）

---

### 步驟 3: 配置 Secrets（重要！）

⚠️ **必須在部署前配置 API Key**

1. **點擊 "Advanced settings"**
   - 在創建應用頁面或應用設置中

2. **打開 Secrets 編輯器**
   - 點擊 "Edit secrets" 或 "Secrets" 選項卡

3. **添加 API Key**
   在編輯器中輸入：
   ```toml
   GEMINI_API_KEY = "your-api-key-here"
   ```
   
   **重要**:
   - 將 `your-api-key-here` 替換為您的實際 Gemini API Key
   - 確保使用雙引號
   - 不要有多餘的空格

4. **保存**
   - 點擊 "Save" 或 "Save secrets"

---

### 步驟 4: 獲取 Gemini API Key（如果還沒有）

1. **訪問 Google AI Studio**
   ```
   https://makersuite.google.com/app/apikey
   ```

2. **登錄 Google 帳號**

3. **創建 API Key**
   - 點擊 "Create API Key"
   - 選擇或創建 Google Cloud 項目
   - 複製生成的 API Key

4. **在 Streamlit Cloud 配置**
   - 將 API Key 添加到 Secrets

---

### 步驟 5: 部署應用

1. **確認配置**
   - Main file: `app.py` ✅
   - Branch: `main` ✅
   - Secrets: `GEMINI_API_KEY` 已配置 ✅

2. **點擊 "Deploy"**
   - 等待 1-2 分鐘
   - 查看部署日誌

3. **部署成功**
   - 您會看到 "Your app is live!"
   - 獲得應用 URL，例如：
     ```
     https://your-app-name.streamlit.app
     ```

---

## ✅ 第三步：驗證部署

### 必須測試的功能

#### 1. 訪問應用
- [ ] 打開應用 URL
- [ ] 確認頁面正常加載
- [ ] 確認沒有錯誤信息

#### 2. 測試註冊功能
- [ ] 點擊 "註冊" 按鈕
- [ ] 輸入郵箱和密碼
- [ ] 確認註冊成功
- [ ] 確認自動登錄

#### 3. 測試登錄功能
- [ ] 登出（如果已登錄）
- [ ] 使用註冊的帳號登錄
- [ ] 確認登錄成功

#### 4. 測試 OCR 識別
- [ ] 上傳一張發票圖片
- [ ] 選擇識別模型
- [ ] 點擊 "開始識別"
- [ ] 確認識別結果正確

#### 5. 測試數據操作
- [ ] 測試數據編輯
- [ ] 測試數據刪除（含確認對話框）
- [ ] 測試數據導出（CSV）
- [ ] 測試數據導出（PDF，如果可用）

#### 6. 測試其他功能
- [ ] 測試數據導入（CSV/Excel）
- [ ] 測試圖表顯示
- [ ] 測試搜索和篩選功能

---

## 🆘 故障排除

### 問題 1: 部署失敗

**可能原因**:
- requirements.txt 有問題
- 代碼語法錯誤
- API Key 未配置

**解決方法**:
1. 查看 Streamlit Cloud 的錯誤日誌
2. 檢查 requirements.txt 是否完整
3. 確認 API Key 已正確配置

---

### 問題 2: OCR 識別失敗

**可能原因**:
- API Key 無效或未配置
- API Key 配額用盡
- 網絡問題

**解決方法**:
1. 檢查 Secrets 中的 API Key 是否正確
2. 確認 API Key 是否有效（訪問 Google AI Studio）
3. 檢查 API 使用限額

---

### 問題 3: 無法登錄

**可能原因**:
- 未註冊帳號
- 密碼錯誤
- 數據庫初始化失敗

**解決方法**:
1. 使用註冊功能創建新帳號
2. 確認密碼正確
3. 查看 Streamlit Cloud 日誌中的錯誤信息

---

### 問題 4: Git 推送失敗

**可能原因**:
- 文件權限問題
- 其他程序占用 Git
- 網絡問題

**解決方法**:
1. 關閉 VS Code 和其他可能使用 Git 的程序
2. 以管理員身份運行 PowerShell
3. 檢查網絡連接
4. 使用提供的腳本（git_push.bat 或 git_push.ps1）

---

## 📊 部署後監控

### 第一小時
- [ ] 監控應用運行狀態
- [ ] 檢查錯誤日誌
- [ ] 測試所有核心功能

### 第一天
- [ ] 監控用戶註冊情況
- [ ] 監控 API 使用量
- [ ] 收集用戶反饋
- [ ] 檢查數據庫大小

### 第一週
- [ ] 分析使用情況
- [ ] 優化性能瓶頸
- [ ] 修復發現的問題

---

## 📞 支持資源

### 文檔
- `立即部署指南.md` - 快速部署指南
- `部署快速開始.md` - 三種部署方式
- `上線部署指南_20260126.md` - 完整部署指南
- `部署前檢查報告_20260126.md` - 檢查報告

### 關鍵文件
- `app.py` - 主應用文件
- `requirements.txt` - 依賴列表
- `.gitignore` - Git 忽略文件配置

---

## ✅ 部署完成確認

**部署狀態**: ⏳ **準備執行**

**下一步**:
1. 執行 Git 推送（使用腳本或手動）
2. 在 Streamlit Cloud 創建應用
3. 配置 Secrets（GEMINI_API_KEY）
4. 部署應用
5. 驗證所有功能

---

**祝部署順利！** 🚀

**如有問題，請查看故障排除部分或相關文檔。**
