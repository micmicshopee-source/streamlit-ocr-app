# 部署執行指南

**日期**: 2026-01-26  
**版本**: 生產版本 v1.0  
**狀態**: ✅ 準備部署

---

## 🚀 快速部署步驟

### 方式一：Streamlit Cloud 部署（最簡單，推薦）

#### 步驟 1: 準備 Git 倉庫
```bash
# 1. 確保 .gitignore 包含敏感文件
# 檢查 .gitignore 是否包含：
# - invoices_v2.db
# - invoice_images/
# - .streamlit/secrets.toml

# 2. 初始化 Git（如果還沒有）
git init
git add .
git commit -m "準備上線：清理測試內容，修復關鍵 Bug"
```

#### 步驟 2: 上傳到 GitHub
```bash
# 1. 在 GitHub 創建新倉庫（如果還沒有）
# 訪問 https://github.com/new

# 2. 添加遠程倉庫並推送
git remote add origin https://github.com/your-username/your-repo.git
git branch -M main
git push -u origin main
```

#### 步驟 3: 在 Streamlit Cloud 部署
1. **訪問 Streamlit Cloud**: https://share.streamlit.io
2. **登錄**: 使用 GitHub 帳號登錄
3. **創建新應用**:
   - 點擊 "New app"
   - 選擇您的 GitHub 倉庫
   - 設置主文件路徑：`app.py`
   - 設置分支：`main`
4. **配置 Secrets**:
   - 點擊 "Advanced settings"
   - 在 "Secrets" 中添加：
     ```
     GEMINI_API_KEY = "your-api-key-here"
     ```
5. **部署**: 點擊 "Deploy"
6. **等待部署完成**: 通常需要 1-2 分鐘
7. **訪問應用**: 部署完成後會獲得一個 URL，例如：`https://your-app.streamlit.app`

---

### 方式二：本地部署

#### 步驟 1: 安裝依賴
```bash
# 進入項目目錄
cd d:\streamlit_ocr_app

# 安裝依賴
pip install -r requirements.txt
```

#### 步驟 2: 配置 API Key

**方法 A: 使用 Streamlit Secrets（推薦）**
```bash
# 創建 .streamlit 目錄
mkdir .streamlit

# 創建 secrets.toml 文件
# Windows PowerShell:
@"
GEMINI_API_KEY = "your-api-key-here"
"@ | Out-File -FilePath .streamlit\secrets.toml -Encoding utf8

# Windows CMD:
echo GEMINI_API_KEY = "your-api-key-here" > .streamlit\secrets.toml
```

**方法 B: 使用環境變數**
```bash
# Windows PowerShell:
$env:GEMINI_API_KEY="your-api-key-here"

# Windows CMD:
set GEMINI_API_KEY=your-api-key-here

# Linux/Mac:
export GEMINI_API_KEY="your-api-key-here"
```

#### 步驟 3: 啟動應用
```bash
streamlit run app.py
```

應用將在 `http://localhost:8501` 啟動

---

### 方式三：Docker 部署

#### 步驟 1: 創建 Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安裝依賴
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 複製應用文件
COPY app.py .
COPY NotoSansTC-Regular.ttf .  # 如果使用 PDF 導出

# 創建數據目錄
RUN mkdir -p /app/data

# 暴露端口
EXPOSE 8501

# 啟動命令
CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

#### 步驟 2: 構建和運行
```bash
# 構建鏡像
docker build -t invoice-ocr-app .

# 運行容器
docker run -d \
  -p 8501:8501 \
  -e GEMINI_API_KEY=your-api-key-here \
  -v $(pwd)/data:/app/data \
  --name invoice-ocr-app \
  invoice-ocr-app
```

---

## 📋 部署前最後檢查

### 必需檢查項
- [ ] 已獲取 Gemini API Key
- [ ] 已配置 API Key（Secrets 或環境變數）
- [ ] 已測試註冊功能
- [ ] 已測試登錄功能
- [ ] 已確認無測試內容殘留

### 建議檢查項
- [ ] 已備份現有數據（如有）
- [ ] 已閱讀部署指南
- [ ] 已準備監控方案

---

## ⚙️ 部署後配置

### 1. 首次使用
1. 訪問應用 URL
2. 使用「註冊」功能創建第一個帳號
3. 登錄後開始使用

### 2. 預配置管理員（可選）
如果需要預配置管理員帳號，在 Streamlit Secrets 中添加：
```toml
USERS = {
    "admin@company.com": "secure-password"
}
```

---

## 🔍 部署驗證

### 驗證步驟
1. **訪問應用**: 確認應用可以正常訪問
2. **測試註冊**: 創建一個測試帳號
3. **測試登錄**: 使用註冊的帳號登錄
4. **測試 OCR**: 上傳一張發票圖片測試識別
5. **測試數據操作**: 測試編輯、刪除、導出功能

### 常見問題排查
- **無法訪問**: 檢查端口是否正確，防火牆設置
- **API Key 錯誤**: 檢查 Secrets 配置是否正確
- **數據庫錯誤**: 檢查文件權限
- **OCR 失敗**: 檢查 API Key 和網絡連接

---

## 📊 部署後監控

### 第一小時
- [ ] 監控應用是否正常運行
- [ ] 檢查是否有錯誤日誌
- [ ] 測試核心功能

### 第一天
- [ ] 監控用戶註冊情況
- [ ] 監控 API 使用量
- [ ] 收集用戶反饋
- [ ] 檢查數據庫大小

### 第一週
- [ ] 分析使用情況
- [ ] 優化性能瓶頸
- [ ] 修復發現的問題

---

## 🆘 緊急處理

### 如果部署失敗
1. 檢查 Streamlit Cloud 日誌
2. 檢查 API Key 配置
3. 檢查依賴安裝
4. 查看錯誤信息

### 如果需要回滾
1. 在 Streamlit Cloud 中選擇之前的版本
2. 或使用 Git 回滾到之前的提交

---

## ✅ 部署完成確認

**部署狀態**: ⏳ **準備部署**

**下一步**:
1. 選擇部署方式
2. 按照步驟執行
3. 驗證部署成功
4. 開始使用

---

**文檔版本**: v1.0  
**創建日期**: 2026-01-26  
**狀態**: ✅ 準備部署

**祝部署順利！** 🚀
