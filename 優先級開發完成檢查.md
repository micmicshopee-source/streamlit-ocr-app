# 優先級開發完成檢查（登入嚴謹化）

**完成日期**：2026-01-29  
**對應**：產品需求文檔 AUTH-01～AUTH-05、P0/P1 登入嚴謹化

---

## 一、已實作項目

### AUTH-01 密碼安全雜湊

- **實作**：優先使用 **bcrypt** 產生密碼雜湊；未安裝 bcrypt 時退回 `sha256:` 前綴 + SHA256。
- **相容**：`verify_password()` 支援三種格式：bcrypt 字串、`sha256:` + hex、舊版純 64 字元 hex（無前綴），既有用戶可照常登入。
- **依賴**：`requirements.txt` 已加入 `bcrypt>=4.0.0`；部署時請執行 `pip install -r requirements.txt`。

### AUTH-02 密碼強度

- **規則**：至少 8 字元；且含「大寫、小寫、數字、符號」其中至少兩類。
- **實作**：`validate_password_strength()`；註冊、重設密碼時前後端皆檢核。
- **文案**：註冊／重設密碼欄位提示已改為「至少 8 字元，含大小寫/數字/符號其中兩類」。

### AUTH-03 登入失敗鎖定

- **規則**：同一帳號（email）在 15 分鐘內失敗 5 次即鎖定 15 分鐘。
- **實作**：`login_attempts` 表（account_key, attempt_at, success）；`is_login_locked()`、`_record_login_attempt()`、`_clear_login_attempts()`。
- **流程**：`verify_user()` 開頭先檢查鎖定；密碼錯誤時寫入失敗記錄；登入成功時清除該帳號記錄。
- **訊息**：鎖定時回傳「帳號暫時鎖定，請 15 分鐘後再試」。

### AUTH-04 Session 過期

- **規則**：登入後 24 小時未活動則 Session 過期，須重新登入。
- **實作**：`st.session_state.login_at` 於登入／註冊成功時寫入；主入口檢查逾時則清空 `authenticated`、`user_email`、`login_at`；登出時一併清除 `login_at`。
- **常數**：`_SESSION_EXPIRE_HOURS = 24`（可依需求調整）。

### AUTH-05 CSRF

- **實作**：登入頁載入時產生 `login_csrf_token`（`secrets.token_hex(16)`）；登入／註冊成功後清除 token。
- **說明**：Streamlit 同源，目前以「表單顯示時設定 token、成功後清除」為最小實作；若需嚴格驗證表單欄位可再擴充。

### 其他修正

- **Secrets 字串解析**：修正 `USERS` 為字串時，迴圈內 `if user_email.strip() == email` 縮排錯誤，現已正確比對每行。
- **錯誤訊息**：僅支援第三方登入之帳號改為「請使用 Google / LINE / Facebook 登入」。

---

## 二、建議手動檢查項目

1. **註冊**：輸入 6 字元密碼應被拒絕並顯示強度訊息；8 字元且含兩類（如 `Abcdef1!`）應通過並寫入 bcrypt 雜湊。
2. **登入**：既有帳號（舊 SHA256 雜湊）應可正常登入；新註冊帳號用新密碼登入應成功。
3. **重設密碼**：僅本站註冊帳號可重設；新密碼須通過強度檢核。
4. **鎖定**：同一帳號連續 5 次錯誤密碼後，應顯示「帳號暫時鎖定，請 15 分鐘後再試」；15 分鐘後或重啟應用後可再試。
5. **Session**：登入後將 `login_at` 改為超過 24 小時再重新整理，應被登出並回到登入頁（或於本機暫時改小 `_SESSION_EXPIRE_HOURS` 測試）。
6. **登出**：登出後再進入應顯示登入頁；側邊欄小工具、發票報帳流程應正常。

---

## 三、尚未實作（依 PRD 優先級）

- **P0**：Google 登入、LINE 登入（OAuth 2.0，需環境變數與 redirect 設定，見《開發文檔》）。
- **P1**：Facebook 登入；AI 合約比對／客服小秘／會議精華（小工具佔位頁已存在）。
- **P2**：Instagram 登入、稽核日誌、更多辦公小工具。

以上為本次登入嚴謹化與檢查結果；請在實際環境執行 `streamlit run app.py` 並依「二、建議手動檢查項目」驗收。
