# 會計科目邏輯檢查報告

**檢查日期**: 2026-01-26  
**檢查項目**: 會計科目（subject）字段的完整邏輯

---

## 📋 當前邏輯分析

### 1. 字段定義

#### 數據庫字段
- **字段名**: `subject` (TEXT)
- **顯示名稱**: `會計科目`
- **用途**: 存儲會計科目分類

#### 字段映射
```python
# 數據庫 -> 顯示
"subject" -> "會計科目"

# 顯示 -> 數據庫
"會計科目" -> "subject"
```

---

### 2. OCR 識別邏輯

#### Prompt 要求
```python
- category_suggest (Category, e.g., "餐飲", "交通", "辦公用品")
```

#### 數據處理
```python
# app.py:1112
"category_suggest": raw.get("category_suggest") or "雜項"

# app.py:1382, 1442
'subject': safe_value(data.get("category_suggest"), "雜項")
```

**邏輯**:
- OCR 返回 `category_suggest` 字段
- 映射到數據庫的 `subject` 字段（會計科目）
- 如果沒有值，默認使用 `"雜項"`

---

### 3. CSV 導入邏輯

#### 字段識別
```python
# app.py:1504
"會計科目": ["會計科目", "subject", "Subject", "科目"]
```

#### 數據處理
```python
# app.py:1564
'subject': safe_str(row.get("會計科目"), "雜項")
```

**邏輯**:
- 支持多種列名：`會計科目`、`subject`、`Subject`、`科目`
- 如果沒有值，默認使用 `"雜項"`

---

### 4. 數據顯示邏輯

#### 列名映射
```python
# app.py:1229, 1619, 1790
mapping = {
    "subject": "會計科目",
    ...
}
```

#### 圖表顯示
```python
# app.py:1633-1643
# 圓餅圖 - 會計科目分布
if "會計科目" in df_chart.columns:
    df_pie = df_chart[df_chart['會計科目'].notna() & (df_chart['會計科目'] != 'No')].copy()
    # 顯示會計科目分布餅圖
```

---

### 5. PDF 導出邏輯

#### 備註字段
```python
# app.py:1957
note = pdf_safe_value(
    row.get('備註', '') or 
    row.get('會計科目', '') or 
    row.get('類型', ''), 
    ''
)[:15]
```

**邏輯**:
- PDF 的"備註"列優先順序：`備註` > `會計科目` > `類型`
- 如果都沒有，顯示空字符串

---

## ⚠️ 發現的問題

### 問題 1: 字段命名混淆
- **類型 (category)**: 發票類型（如"電子發票"、"收據"）
- **會計科目 (subject)**: 會計分類（如"餐飲"、"交通"）
- **問題**: OCR 返回的 `category_suggest` 實際上是會計科目建議，但命名可能造成混淆

### 問題 2: 默認值"雜項"
- 當前默認值：`"雜項"`
- **問題**: 如果 OCR 沒有識別出會計科目，所有記錄都會顯示"雜項"，可能不夠精確

### 問題 3: 字段用途不清
- `category` (類型): 用於發票類型分類
- `subject` (會計科目): 用於會計科目分類
- **問題**: 兩個字段的用途區分不夠明確

---

## ✅ 邏輯檢查結果

### 正確的部分
1. ✅ 字段映射正確：`subject` ↔ `會計科目`
2. ✅ CSV 導入支持多種列名
3. ✅ 圖表顯示邏輯正確
4. ✅ PDF 導出有備用邏輯

### 需要改進的部分
1. ⚠️ OCR Prompt 中的 `category_suggest` 命名可能造成混淆
2. ⚠️ 默認值"雜項"可能需要更明確的說明
3. ⚠️ 字段用途說明不夠清晰

---

## 🔍 詳細檢查

### OCR 處理流程
1. **Prompt 要求**: `category_suggest` (Category)
2. **返回數據**: `category_suggest` 字段
3. **映射到數據庫**: `subject` 字段
4. **默認值**: `"雜項"`

### CSV 導入流程
1. **識別列名**: `會計科目`、`subject`、`Subject`、`科目`
2. **映射到數據庫**: `subject` 字段
3. **默認值**: `"雜項"`

### 數據顯示流程
1. **數據庫查詢**: `subject` 字段
2. **重命名為**: `會計科目`
3. **圖表顯示**: 會計科目分布餅圖

---

## 💡 建議改進

### 1. 明確字段用途
- **類型 (category)**: 發票類型（二聯式、三聯式、電子發票等）
- **會計科目 (subject)**: 會計分類（餐飲費、交通費、辦公用品等）

### 2. 改進 OCR Prompt
- 明確說明 `category_suggest` 是會計科目建議
- 提供更明確的會計科目選項

### 3. 改進默認值
- 考慮使用空字符串或更明確的默認值
- 或者在 UI 中提示用戶手動填寫

---

**檢查完成時間**: 2026-01-26  
**檢查狀態**: ✅ **邏輯基本正確，但可以改進**
