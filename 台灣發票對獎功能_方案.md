# 台灣發票對獎功能方案

## 一、法規與規則摘要（依《統一發票給獎辦法》）

### 1.1 開獎與期別

- **開獎日**：每**單月 25 日**（1/25、3/25、5/25、7/25、9/25、11/25）。
- **對應期別**：當期開獎的是**前兩個月**的發票。
  - 例：1/25 開獎 → 對應 **11–12 月** 發票；3/25 → **1–2 月**；5/25 → **3–4 月**；7/25 → **5–6 月**；9/25 → **7–8 月**；11/25 → **9–10 月**。
- **領獎期限**：開獎日**次月 6 日起 3 個月內**（例：11–12 月發票 → 次年 2/6～5/5）。

### 1.2 獎別與對獎規則（紙本／一般電子發票）

| 獎別   | 中獎條件（發票 8 位數號碼） | 獎金（新臺幣） |
|--------|----------------------------|----------------|
| 特別獎 | 8 位數**全部相同**         | 1,000 萬元     |
| 特獎   | 8 位數**全部相同**         | 200 萬元       |
| 頭獎   | 8 位數**全部相同**（多組） | 20 萬元        |
| 二獎   | **末 7 位**相同            | 4 萬元         |
| 三獎   | **末 6 位**相同            | 1 萬元         |
| 四獎   | **末 5 位**相同            | 4 千元         |
| 五獎   | **末 4 位**相同            | 1 千元         |
| 六獎   | **末 3 位**相同            | 200 元         |

- 每期：**特別獎 0～1 組**、**特獎 1～3 組**、**頭獎 3～10 組**（實際組數以財政部公告為準）。
- **一張發票僅能領一個獎**：若同時符合多個獎別，以**獎金最高**者為準。

### 1.3 發票號碼格式

- 常見格式：**字軌（2 碼英文） + 8 位數字**，例如 `AB-12345678`、`AB12345678`、`12345678`。
- 對獎時一律以** 8 位數字**為準（去掉字軌與符號後，不足 8 位可視為無效或略過）。

### 1.4 雲端發票專屬獎（可選擴充）

- 另有雲端發票專屬獎（百萬元獎、千元獎、百元獎等），字軌+8 位數全對。
- 本方案**第一階段僅實作紙本／一般電子發票**對獎；雲端專屬獎可列為後續擴充。

---

## 二、功能目標

1. **維護開獎號碼**：可新增／編輯／查詢「某期」的特別獎、特獎、頭獎（多組）、增開六獎等。
2. **一鍵對獎**：依所選期別，對「使用者當期發票」進行對獎，並標示中獎獎別與獎金。
3. **結果展示**：列表／篩選「未中獎／中獎」、依獎別排序、顯示該期可領總金額與領獎期限提醒。
4. **領獎提醒**：可顯示該期領獎截止日，避免過期。

---

## 三、如何取得開獎結果

### 3.1 官方與民間管道整理

| 管道 | 說明 | 取得難度 | 建議 |
|------|------|----------|------|
| **財政部稅務入口網** | 每期開獎後於網頁公布（例：https://www.etax.nat.gov.tw/etw-main/ETW183W2_11411，11411＝114年11–12月） | 網頁瀏覽、複製貼上 | 提供連結 + 手動輸入／貼上 |
| **財政部電子發票整合服務平台 API** | 需向財政部財政資訊中心申請 AppID／APIKey，審查通過後才能呼叫 | 高（申請與審核） | 不建議小型應用申請 |
| **政府開放資料平台 data.gov.tw** | 未見統一發票「開獎號碼」專用開放資料集 | 不適用 | 暫不採用 |
| **財政部印刷廠** | 發票發售與兌獎查詢頁，同樣為網頁呈現 | 同稅務入口網 | 可當備援連結 |

結論：**不依賴 API**，以「連結到財政部 + 使用者手動輸入／貼上」為主要做法，必要時再考慮**實驗性**的自動抓取（見下）。

### 3.2 建議實作：三種取得方式（由簡到繁）

#### 方案 A：手動輸入／貼上（推薦，先做）

- 在「對獎」區提供：
  - **連結**：「[查看財政部最新開獎號碼](https://www.etax.nat.gov.tw/etw-main/etw183w)」開新分頁。
  - **表單**：期別（例：114 年 11–12 月）、特別獎、特獎、頭獎 1～3（或更多）、增開六獎（選填）。
  - **或一大欄「貼上開獎號碼」**：使用者從財政部頁面複製整段文字，系統用簡單規則**解析**（例如抓 8 位數字、依出現順序對應特別獎／特獎／頭獎），解析失敗再請使用者改用手動欄位。
- 優點：無外部依賴、不違反網站使用規定、實作快。  
- 缺點：需使用者手動一次。

#### 方案 B：實驗性自動抓取（可選）

- 財政部稅務入口網網址規則：`https://www.etax.nat.gov.tw/etw-main/ETW183W2_{期別}.html`，期別 5 碼為「民國年 2 碼 + 單月」如 `11411`（114 年 11–12 月）、`11501`（115 年 1–2 月）。
- 後端以 HTTP 取得該頁 HTML，用正則或簡單解析取出：特別獎、特獎、頭獎（多組）、領獎期限等。
- **注意**：頁面結構若改版會失效，需錯誤處理與 fallback；且應遵守網站 robots.txt／使用條款，並註明「僅供個人使用、非官方」。
- 建議：做成「**嘗試自動取得**」按鈕，失敗時提示「請改用手動輸入或從財政部複製貼上」。

#### 方案 C：第三方開獎號碼 JSON／RSS（若有）

- 若未來發現穩定、註明出處的開放資料或民間 API（例如某站提供當期開獎 JSON），可多一個「從網址匯入」選項。
- 目前不作為必要方案，僅預留擴充。

### 3.3 小結

- **第一階段**：只做 **方案 A**（財政部連結 + 手動輸入或貼上 + 簡易解析），即可取得開獎結果並寫入 `invoice_lottery_draws`。
- **可選**：再加 **方案 B** 的「嘗試自動取得」按鈕，失敗時導回方案 A。

---

## 四、如何簡單提示中獎信息給用戶

### 4.1 原則

- **一次看懂**：進入發票／對獎區就能知道「有沒有中獎、中幾張、多少錢、何時前要領」。
- **少步驟**：對獎完成後，結果與提醒主動出現在明顯位置，不必再點多層。

### 4.2 建議的提示方式（由顯眼到補充）

#### 1）對獎結果摘要（必做）

- 在「對獎」執行完成後，**同一頁上方**顯示：
  - **本期（例：114年11–12月）中獎 X 張，共 Y 元。**
  - **領獎期限至 YYYY/MM/DD。**
- 若該期 0 張中獎：**本期未中獎（共 Z 張發票已對獎）。**  
讓用戶立刻知道「有／無中獎」與「要領多少、何時前領」。

#### 2）中獎明細表（必做）

- 緊接在摘要下方：表格列出**有中獎**的發票（發票號碼、日期、賣方、獎別、獎金）。
- 可選：提供「僅顯示中獎」「顯示全部（含未中獎）」切換，預設「僅顯示中獎」以減少干擾。

#### 3）入口處小提示（建議）

- 在發票主區（或側欄）固定顯示一小塊：
  - 若**尚未對獎**：**「本期發票可對獎，前往對獎」** 連結／按鈕。
  - 若**已對獎且有中獎**：**「您有 X 張發票中獎，共 Y 元，領獎期限至 Z」**，點擊可進對獎結果。
  - 若**已對獎且未中獎**：可選擇不顯示，或顯示「本期已對獎，未中獎」。
- 不需進到「按組／按單張」表格就能看到這段提示。

#### 4）發票列表中的中獎標示（可選）

- 在「按單張」或「按組」的發票列表中，對已對獎的發票多一欄或標籤：**「六獎 200元」／「未中獎」** 等。
- 方便用戶在瀏覽發票時順便看到哪些張有中獎，但非必要第一版就做。

#### 5）領獎期限快到時的提醒（可選）

- 若該用戶有未領中獎發票（或系統僅記錄「已對獎」），可在領獎截止日前 **N 天**（例如 7 天或 14 天）於同一小塊或頂部顯示：**「您有 X 張中獎發票將於 YYYY/MM/DD 前到期，請記得領獎。」**
- 不一定要「已領／未領」狀態，僅用「有中獎 + 截止日」即可達到提醒效果。

### 4.3 資訊層級整理

| 位置 | 內容 | 目的 |
|------|------|------|
| 對獎頁・結果區 | 摘要（中獎張數、總金額、領獎期限）+ 中獎明細表 | 對獎後一次看懂 |
| 發票入口／側欄 | 小提示：「可對獎」或「X 張中獎，共 Y 元，期限 Z」 | 不用進表格就看到 |
| 發票列表（可選） | 單張發票的獎別／未中獎 | 瀏覽時順便看 |
| 期限提醒（可選） | 截止日前 N 天提醒 | 減少忘記領獎 |

### 4.4 小結

- **最簡單且必做**：對獎完成後，**同一頁**顯示「本期中獎 X 張、共 Y 元、領獎期限至 YYYY/MM/DD」+ **中獎明細表**。
- **再簡單一步**：在發票主區或側欄加**一塊固定小提示**（可對獎／已中獎 X 張／未中獎），點擊進對獎頁。
- 其餘（列表標籤、期限快到提醒）可列為第二階段。

---

## 五、資料模型建議

### 5.1 開獎號碼表 `invoice_lottery_draws`

| 欄位           | 類型         | 說明 |
|----------------|--------------|------|
| id             | INTEGER PK   | 主鍵 |
| period         | TEXT NOT NULL | 期別，建議格式：`YYYYMM` 或 `YYYMM`（例：`202511`=114年11–12月、`202601`=115年1–2月）。可依現有「日期」欄位換算期別。 |
| draw_date      | DATE          | 開獎日（當期 25 日） |
| special_prize  | TEXT          | 特別獎 8 位數，一組，如 `12345678` |
| top_prize      | TEXT          | 特獎 8 位數，一組 |
| first_prizes   | TEXT          | 頭獎多組，建議存 JSON 陣列，如 `["11111111","22222222","33333333"]` |
| extra_six      | TEXT          | 增開六獎（末 3 位），多組，JSON 陣列，如 `["123","456"]`（若無則空） |
| created_at     | TIMESTAMP     | 建立時間 |
| updated_at     | TIMESTAMP     | 更新時間 |

- **期別與發票對應**：發票的 `date` 落在某兩個月內 → 對應到該期的 `period`（例：發票日期 2025/11/15、2025/12/01 → 期別 `202511`）。

### 5.2 發票表 `invoices` 擴充（可選）

| 欄位             | 類型   | 說明 |
|------------------|--------|------|
| lottery_prize    | TEXT    | 對獎結果：`NULL`／`未中獎`／`六獎`／…／`特別獎` |
| lottery_amount   | INTEGER| 中獎金額（元），未中獎 0 |
| lottery_checked_at | TIMESTAMP | 最後一次對獎時間（可選） |

- 若不想改表，可改為**每次對獎時即時計算**，結果僅存於 session 或前端，或另建「對獎結果快照表」。

### 5.3 對獎結果快照表（可選）`invoice_lottery_results`

| 欄位        | 類型      | 說明 |
|-------------|-----------|------|
| id          | INTEGER PK | 主鍵 |
| user_email  | TEXT      | 用戶 |
| invoice_id  | INTEGER   | 發票 id |
| draw_id     | INTEGER   | 開獎期別 id |
| prize       | TEXT      | 獎別 |
| amount      | INTEGER   | 獎金（元） |
| created_at  | TIMESTAMP | 對獎時間 |

- 用於「記錄某次對獎結果」、避免重複對獎或方便歷史查詢；**第一版可先不做**，僅即時計算並顯示。

---

## 六、對獎邏輯（核心）

### 6.1 發票號碼正規化

- 從 `invoice_number` 取出**連續 8 位數字**；若不足 8 位則視為無效（不參與對獎或標示為「號碼異常」）。
- 例：`AB-12345678` → `12345678`；`CD87654321` → `87654321`。

### 6.2 對獎順序（一張發票只領最高獎）

1. 特別獎：8 位數全同 → 若中，回傳「特別獎」、1,000 萬，結束。
2. 特獎：8 位數全同 → 若中，回傳「特獎」、200 萬，結束。
3. 頭獎：8 位數全同（比對多組）→ 若中，回傳「頭獎」、20 萬，結束。
4. 二獎：頭獎號碼的**末 7 位**與發票末 7 位相同 → 若中，回傳「二獎」、4 萬，結束。
5. 三獎：頭獎號碼的**末 6 位**與發票末 6 位相同 → 若中，回傳「三獎」、1 萬，結束。
6. 四獎：頭獎號碼的**末 5 位**與發票末 5 位相同 → 若中，回傳「四獎」、4 千，結束。
7. 五獎：頭獎號碼的**末 4 位**與發票末 4 位相同 → 若中，回傳「五獎」、1 千，結束。
8. 六獎：頭獎號碼的**末 3 位**與發票末 3 位相同，或發票末 3 位與**增開六獎**任一组相同 → 若中，回傳「六獎」、200 元，結束。
9. 以上皆未中 → 回傳「未中獎」、0 元。

（頭獎有多組時，二～六獎的「末 N 位」皆以**任一组頭獎號碼**為準即可，依財政部規則。）

### 6.3 期別與發票篩選

- 使用者選擇「期別」（例：114 年 11–12 月）。
- 篩選條件：`date` 落在該期兩個月內（例：2025/11/01～2025/12/31）。
- 僅對這些發票跑上述對獎邏輯。

---

## 七、UI／操作流程建議

### 7.1 開獎號碼管理（後台／進階）

- 位置：側欄或「發票」內「對獎」相關區塊的「管理開獎號碼」。
- 操作：選擇期別（年/月或預設 11、1、3、5、7、9 月）→ 輸入特別獎、特獎、頭獎（多組）、增開六獎（可選）→ 儲存。
- 列表：顯示已建立的期別與開獎日，可編輯／刪除。

### 7.2 對獎操作（主要流程）

1. 使用者進入「發票」後，可進入「對獎」子區（Tab 或 expander）。
2. **選擇期別**：下拉選「114 年 11–12 月」等（僅顯示已建立開獎號碼的期別）。
3. 點擊「開始對獎」：系統篩選該期發票、逐張跑對獎邏輯、顯示結果。
4. **結果呈現**：
   - 摘要：該期中獎張數、總獎金、未中獎張數。
   - 領獎期限提醒：本期限至 YYYY/MM/DD。
   - 明細表：發票號碼、日期、賣方、獎別、獎金、備註（可標「已領」等，若未來擴充）。

### 7.3 與現有發票列表的整合

- 在「按單張」或「按組」的發票列表中，可選顯示「對獎結果」欄位（若該發票所屬期別已對過獎且結果有儲存）。
- 或僅在「對獎」Tab 內顯示當次對獎結果，不強制改動主表欄位。

---

## 八、技術要點

### 8.1 期別與日期對應

- 民國年可轉西元年（114 → 2025）。
- 期別 `YYYYMM` 對應月份：  
  - `202511` → 2025/11、2025/12；  
  - `202601` → 2026/01、2026/02；  
  - `202603` → 2026/03、2026/04；依此類推。

### 8.2 號碼正規化與比對

- 正規化：`re.sub(r'\D', '', str(invoice_number))` 取數字，再取末 8 位或唯一 8 位。
- 若正規化後長度 ≠ 8，可標記為「號碼格式異常」、不納入對獎或單獨列出。

### 8.3 相容現有架構

- 現有 `invoices` 已有 `invoice_number`、`date`、`user_email`，不需改表即可做「即時對獎」。
- 開獎號碼存新表 `invoice_lottery_draws`；若需留存對獎紀錄再擴充 `invoice_lottery_results`。

---

## 九、實作階段建議

| 階段 | 內容 | 優先級 |
|------|------|--------|
| **1** | 新增 `invoice_lottery_draws` 表與開獎號碼 CRUD（單一期別：特別獎、特獎、頭獎多組、增開六獎） | 高 |
| **2** | **取得開獎結果**：財政部連結 + 手動輸入／貼上 + 簡易解析（§三 方案 A）；可選「嘗試自動取得」按鈕（§三 方案 B） | 高 |
| **3** | 發票號碼正規化 + 單張對獎函數（依 §1.2 規則） | 高 |
| **4** | UI：對獎 Tab／區塊 → 選擇期別、一鍵對獎、**結果摘要（中獎 X 張、共 Y 元、領獎期限）+ 中獎明細表**（§四） | 高 |
| **5** | **簡單提示**：發票入口／側欄小塊「可對獎」或「X 張中獎共 Y 元，期限 Z」（§4.2(3)） | 建議 |
| **6** | （可選）`invoices` 加 `lottery_prize`／`lottery_amount` 或改用 `invoice_lottery_results` 存快照 | 中 |
| **7** | （可選）發票列表顯示「對獎結果」欄、篩選「中獎/未中獎」；領獎期限快到提醒（§4.2(4)(5)） | 中 |
| **8** | （可選）雲端發票專屬獎、或匯入財政部開獎 CSV | 低 |

---

## 十、注意與免責

- 對獎結果**僅供參考**，實際領獎以財政部公告與代發單位核對為準。
- 領獎期限、稅負（如三獎以上扣繳 20%、印花稅等）請依財政部規定，本系統可於 UI 加提醒文字，不負責稅務計算。
- 開獎號碼建議註明來源與更新日期，避免使用者誤用舊號碼。

---

以上為台灣發票對獎功能之方案說明，可依此進行資料表設計與第一階段開發（開獎號碼維護 + 對獎邏輯 + 對獎 UI）。
