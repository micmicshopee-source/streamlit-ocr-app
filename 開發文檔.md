# é–‹ç™¼æ–‡æª” â€” ä¸Šç­æ—å°å·¥å…·

**ç‰ˆæœ¬**ï¼šv2.0  
**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-29  
**å°è±¡**ï¼šå¾Œç«¯ï¼å‰ç«¯é–‹ç™¼ã€ç¶­é‹

**åƒè€ƒ**ï¼š`å°ç£ä¸Šç·šæª¢æŸ¥èˆ‡è¦åŠƒ.md`ï¼ˆç”¢å“ç¶“ç†æª¢æŸ¥å ±å‘Š + ä¸Šç·šè¦åŠƒï¼‰ï¼›æœ¬æ–‡ä»¶å°‡è©²è¦åŠƒç´å…¥é–‹ç™¼è¦é»ï¼Œ**é‡é»ç‚ºå„ªåŒ–ç¾æœ‰åŠŸèƒ½**ã€‚

---

## ä¸€ã€å°ˆæ¡ˆæ¶æ§‹èˆ‡ç›®éŒ„

### 1.1 ç›®éŒ„çµæ§‹ï¼ˆç²¾ç°¡ï¼‰

```
streamlit_ocr_app/
â”œâ”€â”€ app.py                    # ä¸»ç¨‹å¼ï¼ˆç™»å…¥ã€å°å·¥å…·å°èˆªã€ç™¼ç¥¨å ±å¸³ï¼‰
â”œâ”€â”€ theme_m3_responsive.css    # Material 3 æ·±è‰²ä¸»é¡Œ
â”œâ”€â”€ requirements.txt           # Python ä¾è³´
â”œâ”€â”€ .streamlit/
â”‚   â””â”€â”€ secrets.toml          # GEMINI_API_KEYã€USERSã€OAuth é‡‘é‘°ç­‰ï¼ˆå‹¿æäº¤ï¼‰
â”œâ”€â”€ invoices_v2.db             # SQLite è³‡æ–™åº«ï¼ˆusersã€invoicesï¼‰
â”œâ”€â”€ ç”¢å“éœ€æ±‚æ–‡æª”_PRD.md        # ç”¢å“éœ€æ±‚ï¼ˆç™»å…¥ã€åŠŸèƒ½ã€é©—æ”¶ï¼‰
â”œâ”€â”€ é–‹ç™¼æ–‡æª”.md                # æœ¬æ–‡ä»¶ï¼ˆæŠ€è¡“å¯¦ä½œï¼‰
â””â”€â”€ å°ç£ä¸Šç·šæª¢æŸ¥èˆ‡è¦åŠƒ.md      # ä¸Šç·šæª¢æŸ¥èˆ‡å°å·¥å…·è¦åŠƒ
```

### 1.2 æŠ€è¡“æ£§

| é …ç›® | æŠ€è¡“ |
|------|------|
| å‰ç«¯ï¼æ‡‰ç”¨æ¡†æ¶ | Streamlit |
| å¾Œç«¯é‚è¼¯ | Pythonï¼ˆå–®é«”æ–¼ `app.py`ï¼‰ |
| è³‡æ–™åº« | SQLiteï¼ˆ`invoices_v2.db`ï¼‰ |
| AI è¾¨è­˜ | Google Gemini API |
| ç™»å…¥ | é›»å­éƒµä»¶+å¯†ç¢¼ï¼ˆç¾æœ‰ï¼‰ï¼›OAuth 2.0ï¼ˆGoogle / LINE / Facebook / Instagram è¦åŠƒï¼‰ |

### 1.3 ä¸»ç¨‹å¼æ¨¡çµ„æ¦‚è¦½ï¼ˆapp.pyï¼‰

| å€å¡Š | èªªæ˜ |
|------|------|
| Secrets / ä¸»é¡Œ | `_ensure_secrets_file`, `_load_theme_css`, `_safe_secrets_get` |
| ç™»å…¥ï¼è¨»å†Š | `hash_password`, `register_user`, `verify_user`, `user_exists_in_db`, `update_user_password`, `login_page` |
| è³‡æ–™åº« | `get_db_path`, `init_db`, `run_query`ï¼ˆå« user_email éš”é›¢ï¼‰ |
| ç™¼ç¥¨ï¼OCR | `save_invoice_image`, `check_duplicate_invoice`, `save_edited_data`, `process_ocr`, `extract_json` |
| AI åŠ©ç† | `call_gemini_chat`, `parse_expense_from_assistant_reply`, `insert_assistant_draft` |
| ä»‹é¢ | `upload_dialog`, `assistant_dialog`ï¼›ä¸»å…§å®¹ä¾ `st.session_state.current_tool` åˆ‡æ› |

---

## äºŒã€ç¾æœ‰åŠŸèƒ½å„ªåŒ–å¯¦ä½œè¦é»ï¼ˆä¾å°ç£ä¸Šç·šæª¢æŸ¥èˆ‡è¦åŠƒï¼‰

æœ¬ç¯€å°æ‡‰ã€Šå°ç£ä¸Šç·šæª¢æŸ¥èˆ‡è¦åŠƒã€‹èˆ‡ã€Šç”¢å“éœ€æ±‚æ–‡æª”ã€‹ç¬¬å…«ç¯€ï¼Œ**é‡é»ç‚ºå„ªåŒ–ç¾æœ‰åŠŸèƒ½**çš„å¯¦ä½œèˆ‡æª¢æŸ¥ã€‚

### 2.0 å„ªåŒ–ç¸½è¦½

| å„ªåŒ–é …ç›® | èªªæ˜ | å¯¦ä½œç‹€æ…‹å»ºè­° |
|----------|------|----------------|
| å·¦å´å°èˆª | ç§»é™¤ã€Œç³»çµ±ç‹€æ…‹ã€ï¼›æ”¹ç‚ºå°å·¥å…·é¸å–® + å¸³è™Ÿ + é€²éšè¨­å®šæ”¶åˆ | å·²å¯¦ä½œï¼š`st.sidebar` å…§ `tool_options`ã€`current_tool`ã€ç™»å‡ºã€expanderã€Œé€²éšè¨­å®šã€ |
| ä¸»å…§å®¹åˆ‡æ› | ä¾ `current_tool` é¡¯ç¤ºç™¼ç¥¨å ±å¸³æˆ–ã€Œå³å°‡æ¨å‡ºã€ä½”ä½é  | å·²å¯¦ä½œï¼š`if current_tool != "invoice"` å‰‡é¡¯ç¤ºä½”ä½ä¸¦ `st.stop()` |
| ç™»å…¥é  | å°ç£ç”¨èªã€æ¨™é¡Œã€Œä¸Šç­æ—å°å·¥å…·ã€ã€éš±ç§èªªæ˜ | å·²å¯¦ä½œï¼š`login_page()` æ¨™é¡Œ/å‰¯æ¨™/é›»å­éƒµä»¶/ç™»å…¥/éš±ç§ä¸€å¥è©± |
| é é¢æ¨™é¡Œ | ç€è¦½å™¨é ç±¤æ¨™é¡Œ | å·²å¯¦ä½œï¼š`st.set_page_config(page_title="ä¸Šç­æ—å°å·¥å…· | ç™¼ç¥¨å ±å¸³ãƒ»è¾¦å…¬å°å¹«æ‰‹"â€¦)` |
| è³‡æ–™æµèˆ‡éš”é›¢ | å¤šç”¨æˆ¶ `user_email` éš”é›¢ã€DB å¯«å…¥ã€Secrets | ç¶­æŒï¼›ä¸åœ¨å´æ¬„é¡¯ç¤ºè³‡æ–™åº«ç‹€æ…‹ã€å·²å­˜ç­†æ•¸ |

### 2.0.1 ç¾æœ‰åŠŸèƒ½é‚è¼¯èˆ‡è³‡æ–™æµï¼ˆä¾›å„ªåŒ–æ™‚å°ç…§ï¼‰

- **è³‡æ–™ä¾†æº**ï¼šSQLite `invoices_v2.db`ï¼›`users` è¡¨ï¼ˆç™»å…¥ï¼‰ã€`invoices` è¡¨ï¼ˆç™¼ç¥¨ï¼Œä¾ `user_email` éš”é›¢ï¼‰ã€‚
- **æµç¨‹**ï¼šä¸Šå‚³åœ–ç‰‡/CSV â†’ AI è¾¨è­˜æˆ–è§£æ â†’ å¯«å…¥ DB â†’ è¡¨æ ¼ç·¨è¼¯/ç¯©é¸ â†’ å°å‡º CSV/PDFã€‚
- **API**ï¼šGemini API Key å¾ Secrets æˆ–å´é‚Šæ¬„ã€Œé€²éšè¨­å®šã€å–å¾—ï¼›æ¨¡å‹é¸å–®åŒè™•ã€‚
- **ä¸»é¡Œ**ï¼š`theme_m3_responsive.css`ï¼ˆMaterial 3 æ·±è‰²ï¼‰ï¼›ä¸»å€ç‚ºæ¨™é¡Œ â†’ ä¸‰æ­¥é©Ÿå°å¼• â†’ æœ¬æœŸæ•¸æ“šç¸½è¦½ â†’ ç™¼ç¥¨è¡¨æ ¼ã€‚

### 2.0.2 ä¸Šç·šå‰æª¢æŸ¥æ¸…å–®ï¼ˆé–‹ç™¼åŸ·è¡Œï¼‰

- [ ] ç™»å…¥é ï¼šæ¨™é¡Œã€Œä¸Šç­æ—å°å·¥å…·ã€ã€å‰¯æ¨™ã€é›»å­éƒµä»¶/å¯†ç¢¼/ç™»å…¥/è¨»å†Š/é‡è¨­å¯†ç¢¼/ç™»å‡ºã€éš±ç§ä¸€å¥è©±ã€‚
- [ ] å´é‚Šæ¬„ï¼šç„¡ã€Œç³»çµ±ç‹€æ…‹ã€ï¼›æœ‰å°å·¥å…· Radioï¼ˆç™¼ç¥¨ã€åˆç´„æ¯”å°ã€å®¢æœå°ç§˜ã€æœƒè­°ç²¾è¯ï¼‰ã€ç•¶å‰ç”¨æˆ¶ã€ç™»å‡ºã€é€²éšè¨­å®šï¼ˆAPI Keyã€æ¨¡å‹ï¼‰æ”¶åˆã€‚
- [ ] ä¸»å…§å®¹ï¼šé¸ç™¼ç¥¨æ™‚é¡¯ç¤ºå®Œæ•´ç™¼ç¥¨å ±å¸³é ï¼›é¸å…¶ä»–å·¥å…·æ™‚é¡¯ç¤ºã€Œå³å°‡æ¨å‡ºã€ä¸¦ `st.stop()`ã€‚
- [ ] ç™¼ç¥¨å ±å¸³ï¼šOCRã€CSV/Excel å°å…¥ã€ç¸½è¦½ã€è¡¨æ ¼ç·¨è¼¯/ç¯©é¸/åˆªé™¤ã€å°å‡º CSV/PDFã€AI å°åŠ©ç†çš†æ­£å¸¸ä¸”åƒ…ç•¶å‰ç”¨æˆ¶è³‡æ–™ã€‚

### 2.0.3 å°å·¥å…·æ“´å……æ¸…å–®ï¼ˆä¾å°ç£ä¸Šç·šæª¢æŸ¥èˆ‡è¦åŠƒï¼‰

æ–°å¢å°å·¥å…·æ™‚ï¼Œé™¤ä¾æœ¬æ–‡ä»¶ã€Œäº”ã€å°å·¥å…·å°èˆªèˆ‡æ“´å……ã€å¯¦ä½œå¤–ï¼Œå¯ä¾ä¸‹è¡¨è¦åŠƒç¬¬äºŒæ³¢å…¥å£ï¼š

| åœ–ç¤º | å·¥å…·åç¨± | èªªæ˜ |
|------|----------|------|
| ğŸ“‹ | è«‹è³¼ï¼å ±åƒ¹å–®æ•´ç† | å¤šå¼µè«‹è³¼å–®æˆ–å ±åƒ¹å–®æ¬„ä½è¾¨è­˜ã€å½™æ•´æˆè¡¨ |
| ğŸ§¾ | å·®æ—…è²»è©¦ç®— | æ©Ÿç¥¨ã€ä½å®¿ã€æ¯æ—¥é¤è²»ç­‰ï¼Œä¾å…¬å¸è¦å‰‡è©¦ç®—èˆ‡åˆ†é¡ |
| ğŸ“Š | é ç®— vs å¯¦éš› | é ç®—è¡¨èˆ‡å¯¦éš›æ”¯å‡ºï¼ŒAI å°æ¯”èˆ‡æ¨™è¨»å·®ç•° |
| ğŸ—‚ï¸ | æª”æ¡ˆå‘½åå°å¹«æ‰‹ | ä¾å…§å®¹æˆ–è¦å‰‡å»ºè­°çµ±ä¸€æª”å |
| ğŸ“ | æ”¶ç™¼æ–‡ç™»è¨˜ | æ”¶æ–‡/ç™¼æ–‡ç™»éŒ„èˆ‡æŸ¥è©¢ï¼ˆå¯æ¥ AI æ‘˜è¦ï¼‰ |
| ğŸ’° | é›¶ç”¨é‡‘ï¼ä»£å¢Šçµç®— | ä»£å¢Šé …ç›®èˆ‡é‡‘é¡ï¼Œç”¢å‡ºçµç®—è¡¨ä¾›å ±å¸³ |

---

## ä¸‰ã€ç™»å…¥æ¨¡å¡Šåš´è¬¹åŒ–å¯¦ä½œè¦é»

ä»¥ä¸‹å°æ‡‰ã€Šç”¢å“éœ€æ±‚æ–‡æª”ã€‹2.2 ç¯€ï¼Œä¾›é–‹ç™¼å¯¦ä½œèˆ‡é‡æ§‹åƒè€ƒã€‚

### 3.1 å¯†ç¢¼å„²å­˜ï¼šå®‰å…¨é›œæ¹Šï¼ˆAUTH-01ï¼‰

**ç¾ç‹€**ï¼š`hash_password()` ä½¿ç”¨ SHA256ï¼Œç„¡ saltï¼Œä¸ç¬¦åˆç¾ä»£å¯†ç¢¼å„²å­˜å»ºè­°ã€‚

**å»ºè­°**ï¼š

- ä½¿ç”¨ **bcrypt** æˆ– **passlib (bcrypt/argon2)** ç”¢ç”Ÿå¸¶ salt çš„é›œæ¹Šã€‚
- æ–°è¨»å†Šï¼é‡è¨­å¯†ç¢¼æ™‚ä¸€å¾‹ä»¥æ–°æ¼”ç®—æ³•å¯«å…¥ã€‚
- èˆŠå¯†ç¢¼æ¬„ä½å¯ä¿ç•™ï¼›ç™»å…¥é©—è­‰æ™‚è‹¥åµæ¸¬åˆ°èˆŠæ ¼å¼ï¼Œé©—è­‰é€šéå¾Œå¯æ–¼èƒŒæ™¯é‡å¯«ç‚ºæ–°é›œæ¹Šï¼ˆæˆ–åƒ…åœ¨ä¸‹æ¬¡é‡è¨­å¯†ç¢¼æ™‚å‡ç´šï¼‰ã€‚

**ä¾è³´**ï¼š`pip install bcrypt` æˆ– `pip install passlib[bcrypt]`ã€‚

**ç¯„ä¾‹ï¼ˆæ¦‚å¿µï¼‰**ï¼š

```python
import bcrypt

def hash_password(password: str) -> str:
    return bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")

def verify_password(password: str, stored_hash: str) -> bool:
    return bcrypt.checkpw(password.encode("utf-8"), stored_hash.encode("utf-8"))
```

**è³‡æ–™åº«**ï¼š`users.password_hash` å­˜ bcrypt å­—ä¸²ï¼ˆæˆ– Argon2 ç­‰ï¼‰ï¼›è‹¥éœ€ç›¸å®¹èˆŠ SHA256ï¼Œå¯åœ¨é©—è­‰æ™‚ä¾å‰ç¶´åˆ¤æ–·æ ¼å¼ä¸¦åˆ†æ”¯è™•ç†ã€‚

### 3.2 å¯†ç¢¼å¼·åº¦ï¼ˆAUTH-02ï¼‰

- **è¦å‰‡**ï¼šè‡³å°‘ 8 å­—å…ƒï¼›å»ºè­°å«å¤§å°å¯«ã€æ•¸å­—ã€ç¬¦è™Ÿå…¶ä¸­è‡³å°‘å…©é¡ã€‚
- **å¯¦ä½œ**ï¼šè¨»å†Šèˆ‡é‡è¨­å¯†ç¢¼æ™‚ï¼Œå¾Œç«¯ä»¥æ­£å‰‡æˆ–å‡½æ•¸æª¢æ ¸ï¼›å‰ç«¯ï¼ˆStreamlitï¼‰å¯å³æ™‚æç¤ºï¼ŒéŒ¯èª¤æ™‚å›å‚³ã€Œå¯†ç¢¼è‡³å°‘ 8 å­—å…ƒï¼Œä¸”é ˆåŒ…å«â€¦ã€ã€‚

### 3.3 ç™»å…¥å¤±æ•—é–å®šï¼ˆAUTH-03ï¼‰

- **é‚è¼¯**ï¼šåŒä¸€å¸³è™Ÿæˆ–åŒä¸€ IP åœ¨çŸ­æ™‚é–“å…§ï¼ˆå¦‚ 15 åˆ†é˜ï¼‰å¤±æ•—é” N æ¬¡ï¼ˆå¦‚ 5 æ¬¡ï¼‰å¾Œé–å®šä¸€æ®µæ™‚é–“ã€‚
- **å¯¦ä½œ**ï¼š
  - å¯æ–°å¢è¡¨ `login_attempts`ï¼ˆ`account_or_ip`, `attempt_at`, `success`ï¼‰æˆ–ä½¿ç”¨ Redis/è¨˜æ†¶é«”å¿«å–ã€‚
  - æ¯æ¬¡ç™»å…¥å¤±æ•—å¯«å…¥ä¸€ç­†ï¼›æˆåŠŸå‰‡æ¸…é™¤è©²å¸³è™Ÿï¼IP è¨ˆæ•¸ã€‚
  - æŸ¥è©¢æœ€è¿‘ N ç­†å¤±æ•—æ¬¡æ•¸ï¼Œè‹¥ â‰¥ 5 ä¸”æœ€å¾Œä¸€æ¬¡åœ¨ 15 åˆ†é˜å…§ï¼Œå‰‡å›å‚³ã€Œå¸³è™Ÿæš«æ™‚é–å®šï¼Œè«‹ç¨å¾Œå†è©¦ã€ã€‚

### 3.4 Session éæœŸï¼ˆAUTH-04ï¼‰

- **é‚è¼¯**ï¼šç™»å…¥æˆåŠŸå¾Œè¨˜éŒ„ `login_at`ï¼ˆæˆ– `last_activity_at`ï¼‰ï¼›æ¯æ¬¡è«‹æ±‚æª¢æŸ¥æ˜¯å¦è¶…éé–¾å€¼ï¼ˆå¦‚ 24 å°æ™‚æˆ– 7 å¤©ï¼‰ã€‚
- **å¯¦ä½œ**ï¼šStreamlit ä»¥ `st.session_state` å­˜ `authenticated`ã€`user_email`ã€`login_at`ã€‚å¯åœ¨ä¸»å…¥å£æª¢æŸ¥ `login_at`ï¼Œé€¾æ™‚å‰‡æ¸…ç©º session ä¸¦å°å‘ç™»å…¥é ã€‚

### 3.5 CSRFï¼ˆAUTH-05ï¼‰

- **é‚è¼¯**ï¼šç™»å…¥ï¼è¨»å†Šï¼é‡è¨­å¯†ç¢¼è¡¨å–®æäº¤æ™‚é©—è­‰ CSRF Tokenã€‚
- **å¯¦ä½œ**ï¼šç™»å…¥é è¼‰å…¥æ™‚åœ¨ `st.session_state` ç”¢ç”Ÿéš¨æ©Ÿ tokenï¼›è¡¨å–®å…§è—ä¸€æ¬„ä½å¸¶è©² tokenï¼›æäº¤æ™‚æ¯”å°ã€‚æˆ–ä¾ Streamlit èˆ‡éƒ¨ç½²ç’°å¢ƒï¼ˆå¦‚ Cookie SameSiteï¼‰è©•ä¼°æœ€å°å¯è¡Œæ–¹æ¡ˆã€‚

---

## å››ã€ç¬¬ä¸‰æ–¹ç™»å…¥ï¼ˆOAuth 2.0ï¼‰å¯¦ä½œæŒ‡å—

ä»¥ä¸‹ç‚º **Googleã€LINEã€Facebookã€Instagram** ç™»å…¥ä¹‹æŠ€è¡“è¦é»ï¼Œèˆ‡ã€Šç”¢å“éœ€æ±‚æ–‡æª”ã€‹2.1 å°æ‡‰ã€‚

### 4.1 å…±é€šæµç¨‹ï¼ˆOAuth 2.0ï¼‰

1. ä½¿ç”¨è€…é»ã€ŒGoogle / LINE / Facebook / Instagram ç™»å…¥ã€ã€‚
2. å°å‘è©²å¹³å°æˆæ¬Šé ï¼ˆå¸¶ `client_id`ã€`redirect_uri`ã€`scope`ã€`state`ï¼‰ã€‚
3. ä½¿ç”¨è€…åŒæ„å¾Œï¼Œå¹³å°å°å› `redirect_uri` ä¸¦å¸¶ `code`ï¼ˆæˆ– `token`ï¼‰ã€‚
4. å¾Œç«¯ä»¥ `code` å‘å¹³å°æ›å– **access_token**ï¼ˆå¿…è¦æ™‚ **id_token**ï¼‰ã€‚
5. ä»¥ access_token æˆ– id_token å‘å¹³å°å–å¾— **ä½¿ç”¨è€…è­˜åˆ¥èˆ‡ email**ï¼ˆä¾å„å¹³å° APIï¼‰ã€‚
6. ä»¥ **email æˆ–å¹³å°å”¯ä¸€ ID** å°æ‡‰æœ¬ç«™ `users` è¡¨ï¼šè‹¥å·²å­˜åœ¨å‰‡ç™»å…¥ï¼›å¦å‰‡å¯å»ºç«‹æ–°å¸³è™Ÿæˆ–å¼•å°ç¶å®šæœ¬ç«™å¸³è™Ÿã€‚

**æ³¨æ„**ï¼šStreamlit å¤šç‚ºå–®é æ‡‰ç”¨ï¼Œredirect å›ä¾†æ™‚æœƒé‡æ–°è·‘è…³æœ¬ï¼Œéœ€ä»¥ `state` æˆ– query åƒæ•¸é‚„åŸã€Œæ­£åœ¨å®Œæˆ OAuthã€çš„ç‹€æ…‹ï¼Œä¸¦åœ¨ç•¶æ¬¡è«‹æ±‚å…§å®Œæˆæ› tokenã€æŸ¥è©¢ä½¿ç”¨è€…ã€å¯«å…¥ sessionã€‚

### 4.2 è³‡æ–™åº«æ“´å……ï¼ˆç¬¬ä¸‰æ–¹å¸³è™Ÿï¼‰

å»ºè­°åœ¨ `users` è¡¨æ–°å¢æ¬„ä½ï¼ˆè‹¥å°šæœªå­˜åœ¨ï¼‰ï¼š

```sql
-- å·²æœ‰ï¼šid, email, password_hash, google_id, created_at, last_login
ALTER TABLE users ADD COLUMN line_id TEXT;
ALTER TABLE users ADD COLUMN facebook_id TEXT;
ALTER TABLE users ADD COLUMN instagram_id TEXT;
-- è‹¥æœ‰å”¯ä¸€ç´„æŸéœ€æ±‚ï¼Œå¯åŠ  UNIQUE
```

- **ç¶å®šé‚è¼¯**ï¼šåŒä¸€ `email` å¯å°æ‡‰å¤šç¨®ç™»å…¥æ–¹å¼ï¼›æˆ–ä»¥ `google_id` / `line_id` / `facebook_id` å”¯ä¸€å°æ‡‰ä¸€ç­† `users`ï¼Œç™»å…¥æ™‚ä»¥è©² ID æŸ¥è©¢ä¸¦å¯«å…¥ `st.session_state.user_email`ï¼ˆæˆ–çµ±ä¸€è­˜åˆ¥ç¢¼ï¼‰ã€‚

### 4.3 Google ç™»å…¥

- **æ–‡ä»¶**ï¼š[Google OAuth 2.0](https://developers.google.com/identity/protocols/oauth2)
- **å–å¾—**ï¼šGoogle Cloud Console â†’ æ†‘è­‰ â†’ å»ºç«‹ OAuth 2.0 ç”¨æˆ¶ç«¯ IDï¼ˆç¶²é æ‡‰ç”¨ç¨‹å¼ï¼‰ã€‚
- **ç’°å¢ƒï¼Secrets**ï¼š
  - `GOOGLE_CLIENT_ID`
  - `GOOGLE_CLIENT_SECRET`
- **Redirect URI**ï¼šéœ€èˆ‡ Console è¨­å®šä¸€è‡´ï¼Œä¾‹å¦‚ `https://your-domain.com/` æˆ– Streamlit æä¾›çš„å›èª¿è·¯å¾‘ã€‚
- **Scope**ï¼šè‡³å°‘ `email`ã€`openid`ã€`profile`ã€‚
- **æ› token**ï¼š`POST https://oauth2.googleapis.com/token`ï¼ˆgrant_type=authorization_code, code, redirect_uri, client_id, client_secretï¼‰ã€‚
- **å–å¾—ä½¿ç”¨è€…**ï¼š`GET https://www.googleapis.com/oauth2/v2/userinfo`ï¼ˆBearer access_tokenï¼‰æˆ–è§£æ id_token JWTï¼Œå–å¾— emailã€subï¼ˆGoogle IDï¼‰ã€‚

### 4.4 LINE ç™»å…¥

- **æ–‡ä»¶**ï¼š[LINE Login](https://developers.line.biz/en/docs/line-login/)
- **å–å¾—**ï¼šLINE Developers Console â†’ Channel â†’ LINE Loginã€‚
- **ç’°å¢ƒï¼Secrets**ï¼š
  - `LINE_CHANNEL_ID`ï¼ˆClient IDï¼‰
  - `LINE_CHANNEL_SECRET`
- **Redirect URI**ï¼šæ–¼ Channel è¨­å®šèˆ‡æ‡‰ç”¨ä¸€è‡´ã€‚
- **Scope**ï¼š`profile`ã€`openid`ã€`email`ï¼ˆemail éœ€ç”³è«‹å¯©æ ¸é€šéï¼‰ã€‚
- **æˆæ¬Š URL**ï¼š`https://access.line.me/oauth2/v2.1/authorize`
- **æ› token**ï¼š`POST https://api.line.me/oauth2/v2.1/token`ï¼ˆgrant_type=authorization_code, code, redirect_uri, client_id, client_secretï¼‰ã€‚
- **å–å¾—ä½¿ç”¨è€…**ï¼š`GET https://api.line.me/v2/profile`ï¼ˆBearer access_tokenï¼‰å¾— displayNameã€userIdï¼›è‹¥è¦æœ‰ email éœ€ä½¿ç”¨ id_token è§£ç¢¼æˆ– email scopeã€‚

**è­˜åˆ¥**ï¼šä»¥ `userId`ï¼ˆLINEï¼‰ä½œç‚º `line_id` å¯«å…¥ `users`ï¼›è‹¥ç„¡ emailï¼Œå¯å…è¨±åƒ…ä»¥ LINE å»ºç«‹å¸³è™Ÿï¼ˆemail æ¬„ä½å¯ç©ºæˆ–å­˜ line_id@line ç­‰ä½”ä½ï¼‰ã€‚

### 4.5 Facebook ç™»å…¥

- **æ–‡ä»¶**ï¼š[Facebook Login for the Web](https://developers.facebook.com/docs/facebook-login/web)
- **å–å¾—**ï¼šMeta for Developers â†’ æ‡‰ç”¨ç¨‹å¼ â†’ Facebook Login è¨­å®šã€‚
- **ç’°å¢ƒï¼Secrets**ï¼š
  - `FACEBOOK_APP_ID`
  - `FACEBOOK_APP_SECRET`
- **Redirect URI**ï¼šåœ¨ Facebook æ‡‰ç”¨è¨­å®šä¸­åŠ å…¥æœ‰æ•ˆ OAuth é‡æ–°å°å‘ URIã€‚
- **Scope**ï¼šè‡³å°‘ `email`ã€`public_profile`ã€‚
- **æˆæ¬Š URL**ï¼š`https://www.facebook.com/v18.0/dialog/oauth`ï¼ˆclient_id, redirect_uri, state, scopeï¼‰ã€‚
- **æ› token**ï¼š`GET https://graph.facebook.com/v18.0/oauth/access_token`ï¼ˆclient_id, client_secret, redirect_uri, codeï¼‰ã€‚
- **å–å¾—ä½¿ç”¨è€…**ï¼š`GET https://graph.facebook.com/me?fields=id,name,email`ï¼ˆBearer access_tokenï¼‰ï¼Œå¾— `id`ã€`name`ã€`email`ã€‚

**è­˜åˆ¥**ï¼šä»¥ `id` ä½œç‚º `facebook_id` å¯«å…¥ `users`ï¼›email å¯ä½œç‚ºç¶å®šæœ¬ç«™å¸³è™Ÿçš„ä¾æ“šã€‚

### 4.6 Instagram ç™»å…¥ï¼ˆèªªæ˜ï¼‰

- **ç¾æ³**ï¼šInstagram å°ã€Œç´”ç¶²é ä»¥ Instagram å¸³è™Ÿç™»å…¥ã€çš„æ”¯æ´æœ‰é™ã€‚
  - **Instagram Basic Display API**ï¼šå¯å–å¾—åŸºæœ¬è³‡æ–™èˆ‡åª’é«”ï¼Œä½†åå…§å®¹å–å¾—ï¼Œä¸”å¯©æ ¸èˆ‡ç¶­é‹æˆæœ¬è¼ƒé«˜ã€‚
  - **Instagram Graph API**ï¼šåå•†æ¥­å¸³è™Ÿèˆ‡ç²‰å°ˆï¼Œéœ€ Facebook ç²‰çµ²å°ˆé ã€‚
- **å¯¦å‹™å»ºè­°**ï¼š
  - **æ–¹æ¡ˆ A**ï¼šåƒ…æä¾› **Facebook ç™»å…¥**ï¼Œåœ¨ç”¢å“æ–‡æ¡ˆèªªæ˜ã€Œå¯ä½¿ç”¨ Facebook å¸³è™Ÿç™»å…¥ã€ï¼ˆå¤šæ•¸å°ç£ç”¨æˆ¶æœ‰ FBï¼ŒIG èˆ‡ FB åŒå±¬ Metaï¼‰ã€‚
  - **æ–¹æ¡ˆ B**ï¼šè‹¥æœªä¾†éœ€ã€ŒInstagram å¸³è™Ÿã€ç™»å…¥ï¼Œå¯è©•ä¼° Meta æ˜¯å¦æä¾›çµ±ä¸€ç™»å…¥æˆ– Instagram Basic Displayï¼›å¯¦ä½œæ™‚ä»¥ `instagram_id` å°æ‡‰ `users`ï¼Œæµç¨‹é¡ä¼¼ Facebookï¼ˆæˆ–å…±ç”¨åŒä¸€ Meta æ‡‰ç”¨ï¼‰ã€‚
- **éœ€æ±‚æ–‡æª”**ï¼šå·²å°‡ Instagram ç™»å…¥åˆ—ç‚º P2 è¦åŠƒï¼›é–‹ç™¼å¯å…ˆå®Œæˆ Googleã€LINEã€Facebookï¼Œå†è¦–éœ€æ±‚åŠ å…¥ Instagramã€‚

### 4.7 Streamlit èˆ‡ OAuth å°å›

- **é›£é»**ï¼šOAuth å°å›æ™‚ç‚ºæ–°è«‹æ±‚ï¼ŒStreamlit æœƒé‡æ–°åŸ·è¡Œè…³æœ¬ï¼Œéœ€åœ¨ **å–®æ¬¡åŸ·è¡Œ** å…§å®Œæˆã€Œè®€å– query çš„ code/state â†’ æ› token â†’ æŸ¥è©¢/å»ºç«‹ç”¨æˆ¶ â†’ å¯«å…¥ session â†’ å°å‘ä¸»é ã€ã€‚
- **å¯¦ä½œè¦é»**ï¼š
  - åœ¨ `app.py` æœ€å‰æ®µæª¢æŸ¥ `st.query_params`ï¼ˆæˆ– `st.request.url`ï¼‰æ˜¯å¦å¸¶ `code` èˆ‡ `state`ï¼›è‹¥ç‚º OAuth callbackï¼Œå‰‡ä¸é¡¯ç¤ºç™»å…¥è¡¨å–®ï¼Œæ”¹ç‚ºè™•ç† OAuthã€å¯«å…¥ sessionã€`st.rerun()` æˆ–å°å‘é¦–é ã€‚
  - `state` åƒæ•¸å»ºè­°å­˜éš¨æ©Ÿå€¼ä¸¦èˆ‡ session æ¯”å°ï¼Œä»¥é˜² CSRFã€‚
  - Redirect URI å¿…é ˆèˆ‡å„å¹³å°å¾Œå°è¨­å®šå®Œå…¨ä¸€è‡´ï¼ˆå« pathã€trailing slashï¼‰ã€‚

---

## äº”ã€å°å·¥å…·å°èˆªèˆ‡æ“´å……

### 5.1 ç›®å‰å¯¦ä½œ

- **å´é‚Šæ¬„**ï¼š`st.session_state.current_tool` ç”± Radio é¸å–®è¨­å®šï¼Œé¸é …ç‚º `invoice`ã€`contract`ã€`customer_service`ã€`meeting`ã€‚
- **ä¸»å…§å®¹**ï¼šè‹¥ `current_tool != "invoice"`ï¼Œé¡¯ç¤ºã€Œå³å°‡æ¨å‡ºã€ä½”ä½é ä¸¦ `st.stop()`ï¼›å¦å‰‡é¡¯ç¤ºç™¼ç¥¨å ±å¸³å°ç§˜ç¬ˆï¼ˆHeroã€æ­¥é©Ÿã€ç¸½è¦½ã€è¡¨æ ¼ã€å°å‡ºã€AI å°åŠ©ç†ï¼‰ã€‚

### 5.2 æ–°å¢å°å·¥å…·æ­¥é©Ÿ

1. **å´é‚Šæ¬„**ï¼šåœ¨ `tool_options` ä¸­æ–°å¢ä¸€é …ï¼Œä¾‹å¦‚ `("new_tool", "ğŸ†• æ–°å·¥å…·åç¨±")`ã€‚
2. **ä¸»å…§å®¹**ï¼šåœ¨ `if st.session_state.current_tool != "invoice":` ä¹‹å¾Œã€`st.stop()` ä¹‹å‰ï¼Œå¯æ”¹ç‚ºä¾ `current_tool` åˆ†æ”¯ï¼›è‹¥ `current_tool == "new_tool"` å‰‡æ¸²æŸ“æ–°å·¥å…·é é¢ï¼Œå¦å‰‡å†é¡¯ç¤ºã€Œå³å°‡æ¨å‡ºã€ã€‚
3. **æ–°å·¥å…·é **ï¼šç¨ç«‹å€å¡Šæ¸²æŸ“è©²å·¥å…·çš„ UI èˆ‡é‚è¼¯ï¼ˆå¯æŠ½æˆå‡½æ•¸æˆ–å¾ŒçºŒæ‹†æª”ï¼‰ã€‚

### 5.3 ç’°å¢ƒè®Šæ•¸ï¼Secrets æ¸…å–®ï¼ˆç™»å…¥èˆ‡ APIï¼‰

| è®Šæ•¸ | ç”¨é€” | å¿…å¡« |
|------|------|------|
| `GEMINI_API_KEY` | ç™¼ç¥¨ OCRã€AI å°åŠ©ç† | ä½¿ç”¨ AI æ™‚å¿…å¡« |
| `USERS` | Secrets é è¨­å¸³è™Ÿï¼ˆemail:password å¤šè¡Œæˆ– dictï¼‰ | é¸å¡« |
| `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` | Google ç™»å…¥ | Google ç™»å…¥æ™‚å¿…å¡« |
| `LINE_CHANNEL_ID` / `LINE_CHANNEL_SECRET` | LINE ç™»å…¥ | LINE ç™»å…¥æ™‚å¿…å¡« |
| `FACEBOOK_APP_ID` / `FACEBOOK_APP_SECRET` | Facebook ç™»å…¥ | Facebook ç™»å…¥æ™‚å¿…å¡« |

---

## å…­ã€éƒ¨ç½²èˆ‡æ³¨æ„äº‹é …

- **HTTPS**ï¼šæ­£å¼ç’°å¢ƒé ˆä½¿ç”¨ HTTPSï¼Œä»¥ä¿è­·ç™»å…¥èˆ‡ Cookieã€‚
- **Secrets**ï¼š`.streamlit/secrets.toml` å‹¿æäº¤è‡³ç‰ˆæ§ï¼›ç”Ÿç”¢ç’°å¢ƒå¯æ”¹ç”¨ç’°å¢ƒè®Šæ•¸æˆ–é›²ç«¯ Secrets ç®¡ç†ã€‚
- **è³‡æ–™åº«**ï¼š`invoices_v2.db` å»ºè­°å®šæœŸå‚™ä»½ï¼›é·ç§»æˆ–æ–°å¢æ¬„ä½æ™‚ä¾ `init_db()` èˆ‡æœ¬æ–‡ä»¶ 4.2 ç¯€åŸ·è¡Œ ALTERã€‚
- **éŒ¯èª¤è™•ç†**ï¼šç™»å…¥èˆ‡ OAuth éŒ¯èª¤æ™‚å‹¿å°‡å…§éƒ¨éŒ¯èª¤è¨Šæ¯ç›´æ¥å›å‚³çµ¦ä½¿ç”¨è€…ï¼›å¯è¨˜éŒ„æ—¥èªŒä¸¦å›å‚³é€šç”¨è¨Šæ¯ï¼ˆå¦‚ã€Œç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€ï¼‰ã€‚

---

## ä¸ƒã€åƒè€ƒ

- **ç”¢å“éœ€æ±‚**ï¼š`ç”¢å“éœ€æ±‚æ–‡æª”_PRD.md`
- **ä¸Šç·šèˆ‡å°å·¥å…·è¦åŠƒ**ï¼š`å°ç£ä¸Šç·šæª¢æŸ¥èˆ‡è¦åŠƒ.md`
- **LINE Login**ï¼šhttps://developers.line.biz/en/docs/line-login/
- **Facebook Login**ï¼šhttps://developers.facebook.com/docs/facebook-login/web
- **Google OAuth 2.0**ï¼šhttps://developers.google.com/identity/protocols/oauth2
