# 上線部署指南

**版本**: 生產版本 v1.0  
**日期**: 2026-01-26  
**狀態**: ✅ 已清理測試內容，準備上線

---

## 📋 上線前檢查清單

### ✅ 代碼清理確認
- [x] 移除所有測試帳號
- [x] 移除調試功能
- [x] 移除測試模式選項
- [x] 移除測試數據
- [x] 移除數據庫清理按鈕
- [x] 無語法錯誤
- [x] 無 Linter 錯誤

### ✅ 功能修復確認
- [x] Bug #1: SQL 注入風險（已修復）
- [x] Bug #2: 刪除確認對話框（已修復）
- [x] Bug #3: 篩選後刪除失效（已修復）
- [x] Bug #4: 錯誤處理不完整（已修復）
- [x] Bug #5: OCR 重試機制（已修復）

### ✅ 安全性確認
- [x] 無默認測試帳號
- [x] 密碼使用哈希存儲
- [x] SQL 注入防護
- [x] 多用戶數據隔離
- [x] API Key 安全存儲

---

## 🚀 部署步驟

### 方式一：Streamlit Cloud 部署（推薦）

#### 1. 準備 GitHub 倉庫
```bash
# 確保 .gitignore 包含敏感文件
echo "invoices_v2.db" >> .gitignore
echo "invoice_images/" >> .gitignore
echo ".streamlit/secrets.toml" >> .gitignore
```

#### 2. 上傳到 GitHub
```bash
git add .
git commit -m "準備上線：清理測試內容"
git push origin main
```

#### 3. 在 Streamlit Cloud 配置
1. 訪問 https://share.streamlit.io
2. 點擊 "New app"
3. 選擇 GitHub 倉庫
4. 設置主文件：`app.py`
5. 配置 Secrets：
   ```
   GEMINI_API_KEY = "your-api-key-here"
   ```
6. 點擊 "Deploy"

---

### 方式二：本地部署

#### 1. 安裝依賴
```bash
pip install streamlit google-generativeai Pillow pandas altair requests fpdf2
```

#### 2. 配置 API Key

**方法 A: 使用 Streamlit Secrets（推薦）**
創建 `.streamlit/secrets.toml`:
```toml
GEMINI_API_KEY = "your-api-key-here"
```

**方法 B: 使用環境變數**
```bash
# Windows
set GEMINI_API_KEY=your-api-key-here

# Linux/Mac
export GEMINI_API_KEY=your-api-key-here
```

#### 3. 啟動應用
```bash
streamlit run app.py
```

---

### 方式三：Docker 部署

#### 1. 創建 Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安裝依賴
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 複製應用文件
COPY app.py .
COPY NotoSansTC-Regular.ttf .  # 如果使用 PDF 導出

# 暴露端口
EXPOSE 8501

# 啟動命令
CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

#### 2. 構建和運行
```bash
# 構建鏡像
docker build -t invoice-ocr-app .

# 運行容器
docker run -p 8501:8501 \
  -e GEMINI_API_KEY=your-api-key-here \
  -v $(pwd)/data:/app/data \
  invoice-ocr-app
```

---

## ⚙️ 環境配置

### 必需配置

#### 1. Gemini API Key
- 獲取方式：https://makersuite.google.com/app/apikey
- 配置方式：Streamlit Secrets 或環境變數
- 安全提示：不要將 API Key 提交到代碼倉庫

#### 2. 數據庫配置
- 數據庫文件：`invoices_v2.db`（自動創建）
- 存儲位置：應用目錄
- 備份建議：定期備份數據庫文件

#### 3. 圖片存儲配置
- 存儲目錄：`invoice_images/`（自動創建）
- 按用戶分目錄存儲
- 備份建議：定期備份圖片目錄

### 可選配置

#### 1. PDF 導出字體
- 字體文件：`NotoSansTC-Regular.ttf`
- 位置：應用根目錄
- 如果不存在，PDF 導出使用英文

#### 2. 預配置用戶（可選）
在 `.streamlit/secrets.toml` 中：
```toml
USERS = {
    "admin@company.com": "secure-password"
}
```

---

## 📊 上線後監控

### 關鍵指標
1. **用戶註冊數量**: 監控新用戶註冊
2. **API 使用量**: 監控 Gemini API 調用次數
3. **數據庫大小**: 監控 `invoices_v2.db` 文件大小
4. **錯誤率**: 監控 OCR 識別失敗率
5. **響應時間**: 監控應用響應速度

### 日誌檢查
- Streamlit 運行日誌
- 數據庫錯誤日誌
- API 調用錯誤日誌

---

## 🔧 維護操作

### 數據備份
```bash
# 備份數據庫
cp invoices_v2.db invoices_v2.db.backup.$(date +%Y%m%d)

# 備份圖片目錄
tar -czf invoice_images_backup_$(date +%Y%m%d).tar.gz invoice_images/
```

### 數據恢復
```bash
# 恢復數據庫
cp invoices_v2.db.backup.YYYYMMDD invoices_v2.db

# 恢復圖片目錄
tar -xzf invoice_images_backup_YYYYMMDD.tar.gz
```

### 用戶管理
- 查看用戶：查詢 `users` 表
- 重置密碼：需要直接修改數據庫（不推薦，建議重新註冊）
- 刪除用戶：刪除 `users` 表中的記錄和對應的 `invoices` 數據

---

## ⚠️ 注意事項

### 安全注意事項
1. **API Key 保護**: 不要將 API Key 提交到代碼倉庫
2. **數據備份**: 定期備份數據庫和圖片
3. **訪問控制**: 考慮添加 IP 白名單（如需要）
4. **會話管理**: 考慮添加會話超時機制

### 性能注意事項
1. **數據量**: 如果數據量很大（>1000條），考慮添加分頁
2. **圖片大小**: 建議單張圖片不超過 10MB
3. **批量上傳**: 建議每次不超過 20 張圖片
4. **API 限額**: 注意 Gemini API 的使用限額

### 功能限制
1. **單機部署**: 當前為單機版本，不支持集群
2. **會話管理**: 使用 Streamlit session_state，刷新會清除會話
3. **數據庫**: 使用 SQLite，不適合高並發場景

---

## 🆘 故障排除

### 常見問題

#### 1. 無法登錄
- **原因**: 未註冊帳號或密碼錯誤
- **解決**: 使用註冊功能創建新帳號

#### 2. 數據庫錯誤
- **原因**: 權限不足或文件鎖定
- **解決**: 檢查文件權限，確保應用有寫入權限

#### 3. OCR 識別失敗
- **原因**: API Key 無效或網絡問題
- **解決**: 檢查 API Key，確認網絡連接

#### 4. 圖片上傳失敗
- **原因**: 圖片格式不支持或文件過大
- **解決**: 確保圖片格式為 jpg/png/jpeg，大小不超過 10MB

---

## 📞 支持聯繫

### 問題報告
如遇到問題，請提供：
1. 問題描述
2. 復現步驟
3. 錯誤信息
4. 環境信息（操作系統、Python 版本等）

### 更新日誌
建議維護更新日誌，記錄：
- 功能更新
- Bug 修復
- 性能優化
- 安全更新

---

## ✅ 上線確認

**準備狀態**: ✅ **已準備就緒，可以上線**

**最後確認**:
- [ ] 已配置 API Key
- [ ] 已測試所有功能
- [ ] 已準備數據備份方案
- [ ] 已設置監控
- [ ] 已準備回滾方案

**上線步驟**:
1. 在測試環境進行最後驗證
2. 備份現有數據（如有）
3. 部署到生產環境
4. 監控前 24 小時運行情況
5. 收集用戶反饋

---

**文檔版本**: v1.0  
**創建日期**: 2026-01-26  
**狀態**: ✅ 準備上線
