# 下一階段完成說明 — Google / LINE / Facebook 登入

**完成日期**：2026-01-29  
**對應**：產品需求文檔 P0 第三方登入、開發文檔第四節 OAuth 2.0

---

## 一、已實作項目

### 1. 資料庫

- **users 表**：建立時已含 `line_id`、`facebook_id`；既有資料庫會自動執行 `ALTER TABLE users ADD COLUMN line_id TEXT` 與 `facebook_id TEXT`（若不存在）。

### 2. OAuth 登入流程（Google / LINE / Facebook）

- **授權 URL**：點選「Google」「LINE」「Facebook」後，會先顯示「請點擊以下連結以 [平台] 帳號登入」，點連結後導向該平台授權頁。
- **state**：每次產生隨機 token 並存入 session，callback 時驗證以防 CSRF。
- **callback**：主入口偵測 URL 帶 `code` 與 `state` 時，依 state 判斷平台並呼叫對應 handler，以 code 換 token、取得使用者、查詢或建立用戶，寫入 session 後清除 query params 並 rerun。
- **綁定邏輯**：先以平台 ID（google_id / line_id / facebook_id）查詢；若無則以 email 查詢並更新該欄位；若仍無則建立新用戶（email 為平台 email 或佔位如 `line_xxx@oauth.local`）。

### 3. 登入頁

- 登入模式下方新增三顆按鈕：**🔵 Google**、**🟢 LINE**、**🔷 Facebook**。
- 點任一顆會進入「請點擊以下連結以 [平台] 登入」畫面，可點連結完成授權或按「返回登入頁」取消。

---

## 二、環境變數／Secrets 設定

在 `.streamlit/secrets.toml` 或環境變數中設定下列項目後，對應登入方式才會可用：

| 變數 | 用途 | 範例 |
|------|------|------|
| **Google** | | |
| `GOOGLE_CLIENT_ID` | OAuth 用戶端 ID | 從 Google Cloud Console 取得 |
| `GOOGLE_CLIENT_SECRET` | OAuth 用戶端密鑰 | 同上 |
| **LINE** | | |
| `LINE_CHANNEL_ID` | LINE Login Channel ID | 從 LINE Developers Console 取得 |
| `LINE_CHANNEL_SECRET` | Channel Secret | 同上 |
| **Facebook** | | |
| `FACEBOOK_APP_ID` | Facebook 應用程式 ID | 從 Meta for Developers 取得 |
| `FACEBOOK_APP_SECRET` | 應用程式密鑰 | 同上 |
| **共用** | | |
| `OAUTH_REDIRECT_URI` | OAuth 回調網址（須與各平台後台設定一致） | 本機：`http://localhost:8501/`；正式：`https://你的網域/` |

**重要**：各平台後台的「授權重新導向 URI」必須與 `OAUTH_REDIRECT_URI` **完全一致**（含尾端斜線與 http/https）。

---

## 三、建議手動檢查

1. **未設定金鑰時**：點 Google / LINE / Facebook 應可進入「請點擊以下連結」畫面；若該平台未設定金鑰，可能顯示「未設定 xxx 登入參數」或連結仍可產生（依實作）。點「返回登入頁」應回到登入表單。
2. **已設定 Google 金鑰時**：完成授權後應被導回本應用並登入，側邊欄顯示的用戶為該 Google 帳號的 email（或新建的佔位 email）。
3. **LINE / Facebook**：同上，需在對應平台後台建立應用並設定 Redirect URI。

---

## 四、後續可選

- **Instagram 登入**：列為 P2，可與 Facebook 共用或另接 Instagram Basic Display。
- **綁定既有帳號**：目前為「以 email 自動綁定或新建」；若需「首次第三方登入時選擇綁定本站帳號」可再擴充 UI 與流程。

以上為下一階段（Google / LINE / Facebook 登入）實作與設定說明。
