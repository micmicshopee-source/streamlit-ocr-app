# 發票報帳介面 — 重構設計稿草案（文字描述）

> 目標：統一視覺語言、Google AI Studio 側欄、Stripe 級主工作區、組/明細切換與詳情抽屜。  
> 本草案供確認邏輯後再實作代碼。

---

## 〇、佈局實作方式（不被 st.columns 限制）

- **大膽使用自訂 Layout，不依賴 st.columns 做結構**：
  - **`<style>` 注入**：在 app 啟動時讀取 CSS 檔（或內聯字串），以 `st.markdown("<style>...</style>", unsafe_allow_html=True)` 注入全域樣式，用於主區 max-width、側欄絕對定位、間距、調色盤等。所有佈局相關的 class（如 `.main-content-constrained`、`.sidebar-bottom-fixed`）均在 CSS 中定義。
  - **`st.components.v1.html()`**：當需要**自訂結構**時（例如側欄底部固定區、Segmented Control 的整塊外殼、詳情抽屜的外層、或任意 grid/flex 佈局），直接輸出 HTML 片段，必要時搭配 `height=` 與 `scrolling=False`，讓視覺與互動完全由我們掌控。若需與 Streamlit 狀態連動，可在 HTML 內用 `Streamlit.setComponentValue` 回傳點擊結果，或在外層用按鈕/radio 驅動 rerun。
- **原則**：能用 CSS 解決的（主區寬度、側欄分區、間距、字級）一律用 `<style>`；需要複雜結構或固定定位的區塊，用 `st.components.v1.html` 畫出來，不勉強用 `st.columns` 或 `st.container` 湊數。

---

## 一、佈局架構 (Layout Strategy)

### 1.1 左側導航 — 完全對齊 Google AI Studio

- **結構**  
  - 頂部：單一標題（如「小工具」或產品名），字級略大、主文字色 `#FFFFFF`，與導航項拉開間距（建議 16px 或 24px）。  
  - 中部：導航項列表（發票報帳、AI 合約比對、AI 會議精華、AI 客服小秘等），每項為可點選區塊，未選中為次要文字色 `#9CA3AF`，選中為白字 + 淺灰底（如 `rgba(255,255,255,0.1)`）。  
  - 底部：**固定區** — Avatar（圓形頭像或首字）+ Email，與導航項在視覺與佈局上分離。

- **固定方式**  
  - 使用 **HTML/CSS 絕對定位** 實現「底部用戶區」固定在側欄底部，不隨內容滾動。  
  - **實作建議**：側欄內「底部用戶區」可改為 **`st.components.v1.html`** 輸出一塊固定定位的 HTML（Avatar + Email + 登出連結或按鈕），class 如 `.sidebar-bottom-fixed`，在注入的 `<style>` 中定義 `position: absolute; bottom: 0; left: 0; right: 0; padding: 16px; border-top: 1px solid #333333`。標題與導航仍用 Streamlit 組件，放在側欄上半部；若需絕對定位的容器外殼，也可用 `st.components.v1.html` 包一層 `position: relative` 的側欄內殼。  
  - 備選：側欄內容用 flex + 上部 flex-grow、底部區自然沉底（純 CSS），並限制側欄最大高度與 overflow，使底部在視窗內始終可見。

- **風格**  
  - 簡約、冷淡：無多餘圖標裝飾、無粗邊框；分隔線用 `#333333` 或極細線；Hover 僅輕微背景與文字色變化，過渡約 0.2s。

### 1.2 主工作區 — 寬度限制與呼吸感

- **寬度**  
  - 主內容區（標題、指標卡、篩選、表格/組檢視）**不**全螢幕撐滿。  
  - 在注入的 **`<style>`** 中為主區定義 **max-width**（建議 1200px～1400px，如 1280px）與 **margin: 0 auto**，例如選擇器 `.main .block-container` 或自訂 class `.main-content-constrained`；若主區外層用 **`st.components.v1.html`** 包一個 `<div class="main-content-constrained">`，則所有後續 `st.xxx` 會落在該 div 之後（需注意 Streamlit 渲染順序），因此**優先採用純 CSS 限制 `.main .block-container` 的 max-width** 即可，無須強制用 html 包主內容。  
  - 表格與卡片在該 max-width 內再 100% 寬度即可。

- **間距**  
  - 主區與視窗左右邊緣的 padding、區塊與區塊之間的間距，一律為 **8px 的倍數**（如 16、24、32px），與「間距：8px 倍數原則」一致。

---

## 二、控件選用與互動 (Component Selection)

### 2.1 數據顯示 — Stripe 風格指標卡 (Metric Cards)

- **現狀**  
  - 已有「本期數據總覽」四張卡：本月總計、預計稅額、發票總數、缺失件數，且為本月篩選。

- **重構方向**  
  - **保留並強化**這四張卡為主要 KPI，視覺完全統一為 Stripe 風格：  
    - 背景 `#1E1E1E`，邊框 `#333333`，內邊距 16px 或 24px（8 的倍數）。  
    - 標題（如「本月總計」）用次要文字色 `#9CA3AF`、小字級、可選全大寫或 letter-spacing。  
    - 數值用主文字色 `#FFFFFF`、字級明顯大於標題、字重 600/700。  
    - 可選：左側或左上小色條（accent）點綴，不搶戲。  
  - **不再**讓「關鍵數字」只藏在長表格中；本月金額、稅額總計、筆數、缺失數一律以這四張卡為唯一入口，表格專注「明細列表」。

- **可選擴充**  
  - 若產品需要「全部期間」總計，可再增加一張「總計（全部）」卡，或於現有卡片旁用次要文字標註「僅本月」，邏輯保持單一來源（本月 = 當月 1 日～今日）。

### 2.2 批次管理 — 組檢視 / 明細檢視切換 (Segmented Control)

- **需求**  
  - 使用者可在「組檢視」與「明細檢視」之間**無縫切換**，且切換方式優雅、符合現代後台（如 Stripe Dashboard）的 Segmented Control。

- **定義**  
  - **明細檢視**：現有「發票明細」表格，一列一筆發票，支援勾選、篩選、刪除、導出等。  
  - **組檢視**：依維度彙總的視圖，例如：  
    - 按「會計科目」分組：每個科目一張小卡或一區塊，顯示該科目下筆數、金額小計、可展開看該組內發票列表（或點擊進入明細並篩選到該組）。  
    - 或按「類型」、按「月份」分組，依產品優先級擇一或提供切換維度。  
  - 預設可為「明細檢視」；切換不影響篩選條件（日期、狀態等），僅切換「同一份篩選後數據」的呈現方式。

- **控件形式**  
  - **Segmented Control**：兩段式（組檢視 | 明細檢視），外觀為一橫條、選中段背景 `#1E1E1E` 或略亮、邊框 `#333333`，未選中為次要文字色，選中為主文字色；點擊即切換，無需再按「套用」。  
  - 實作可為：`st.radio` 水平 + 自訂 CSS 做成 pill/segment 外觀，或純 HTML/CSS + `st.session_state.view_mode = "group" | "detail"` 與按鈕/連結觸發 rerun。

### 2.3 修改行為 — 詳情抽屜 (Detail Drawer)

- **觸發**  
  - 在**明細檢視**下，使用者「點選某一筆」時，應能打開**右側詳情抽屜**。  
  - Streamlit 無真實 DOM 事件，故「點選一列」改為：  
    - 方案 A：表格每列提供「查看」按鈕，點擊後將該筆 id 寫入 `session_state` 並打開抽屜。  
    - 方案 B：先選一筆（例如用下拉選單選「發票號碼 + 日期」或列表選 id），再點「打開詳情」按鈕。  
  - 建議採用方案 A（每列一個「查看」），減少一步操作，更貼近「點選即開」。

- **抽屜佈局**  
  - **右側彈出**，覆蓋在主內容右側，寬度約 480px～560px（或 40vw，上限 560px），自右向左滑入（若框架支援動畫）。  
  - 內容分兩欄（可上下堆疊於小螢幕）：  
    - **左側**：該筆發票的**圖片**（來自 `image_path` 或 `image_data` BLOB）；若無圖則顯示佔位文案「無發票圖片」。  
    - **右側**：該筆的**可編輯欄位**（日期、發票號碼、賣方、金額、會計科目、類型、備註等），以表單形式呈現，與現有後端 UPDATE 邏輯對接。  
  - 底部：**儲存**、**關閉**。儲存時寫回 DB 並關閉抽屜（或刷新列表）；關閉僅關抽屜。

- **技術對應**  
  - Streamlit 可用 `@st.dialog` 模擬「抽屜」：大寬度、標題為「發票詳情」或該筆發票號碼，內容為左圖右表單，符合「邊看邊改」的體驗。  
  - 若希望嚴格「自右側滑入」視覺，可在同一頁用 `st.container` + 條件渲染（當 `session_state.detail_row_id` 不為空時在右側渲染一固定寬度區塊），並用 CSS 做 slide-in；否則以 dialog 為先即可。

---

## 三、視覺統一性 (Visual Polishing)

### 3.1 調色盤（全域）

- **背景**：`#0F0F0F`（主背景）  
- **卡片 / 區塊底色**：`#1E1E1E`  
- **邊框、分隔線**：`#333333`  
- **主文字**：`#FFFFFF`  
- **次要文字**：`#9CA3AF`  
- **輔助 / 禁用**：可在 `#6B7280` 或 `#9CA3AF` 再降一階，用於 placeholder、禁用按鈕等。

按鈕、連結、標籤等僅在上述色階上微調（如主按鈕用品牌藍），不新增額外主色，保持介面冷淡、統一。

### 3.2 間距

- 所有組件之間（卡片與卡片、表單與表單、區塊與區塊）的 **margin / padding** 均為 **8px 的倍數**（8、16、24、32、40、48px）。  
- 側欄內部、主區內部、抽屜內部皆遵守同一規則，方便後續維護與響應式調整。

### 3.3 字體與字級

- 標題（h1/h2）與數值：主文字色、字重 600/700。  
- 正文與標籤：次要文字色、字重 400/500。  
- 小字（caption、placeholder）：輔助色、字級略小。  
- 不依賴「加粗」區分層級，而以**字級 + 顏色**區分，符合「視覺階層」原則。

---

## 四、實作順序建議（確認草案後）

1. **CSS 與佈局**  
   - 側欄 HTML 結構（標題 + 導航 + 底部固定區）與主區 max-width 的 CSS；注入現有 `premium_dark.css` 或新建片段。

2. **指標卡**  
   - 確保四張卡完全使用統一樣式（#1E1E1E、#333333、8px 倍數間距），與調色盤一致。

3. **Segmented Control**  
   - 實作「組檢視 / 明細檢視」切換與狀態；組檢視的資料來源與彙總邏輯（按會計科目或類型）。

4. **詳情抽屜**  
   - 明細表中每列「查看」+ `st.dialog`（或右側區塊）左圖右表單，與 DB 更新串接。

5. **收尾**  
   - 全站間距與色階檢查、響應式（主區 max-width 在小螢幕下的表現）。

---

## 五、小結

| 項目 | 方向 |
|------|------|
| 左側導航 | Google AI Studio：標題 + 導航列表 + 底部固定（Avatar + Email），HTML/CSS 絕對定位或 flex 沉底，簡約冷淡。 |
| 主工作區 | max-width 約 1200～1400px，置中，左右留白；間距 8px 倍數。 |
| 關鍵數據 | 四張 Stripe 風格指標卡（本月總計、稅額、筆數、缺失），不依賴長表。 |
| 批次檢視 | Segmented Control 切換「組檢視」與「明細檢視」，組檢視為彙總卡/列表。 |
| 單筆編輯 | 明細表每列「查看」→ 右側詳情抽屜（左圖右表單），邊看邊改，儲存寫回 DB。 |
| 視覺 | 全域 #0F0F0F / #1E1E1E / #333333 / #FFFFFF / #9CA3AF；間距 8px 倍數。 |

若此邏輯與預期一致，再依此草案產出具體代碼（CSS、側欄結構、主區寬度、Segmented Control、詳情抽屜與資料綁定）。

---

## 六、Layout 實作備忘（不被 st.columns 限制）

| 手段 | 用途 |
|------|------|
| **`st.markdown("<style>...</style>", unsafe_allow_html=True)`** | 注入全域佈局：主區 `.main .block-container` 的 max-width（1280px）、置中、側欄 `.sidebar-bottom-fixed` 絕對定位、間距 8px 倍數、調色盤。 |
| **`st.components.v1.html(html_string, height=..., scrolling=False)`** | 側欄底部固定區（Avatar + Email + 登出）、Segmented Control 外殼、詳情抽屜外層、或任意自訂 grid/flex 區塊；需與 Streamlit 狀態連動時，可在外層用 `st.button`/`st.radio` 驅動 rerun，或在 HTML 內用 `Streamlit.setComponentValue` 回傳。 |
| **原則** | 能用 CSS 解決的用 `<style>`；需要複雜結構或固定定位的用 `st.components.v1.html` 畫出來，不勉強用 `st.columns` 湊數。 |
