# å¤šç”¨æˆ·éš”ç¦»ç‰ˆæœ¬ - æ ¸å¿ƒä»£ç è¯´æ˜

## âœ… å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. æ•°æ®åº“ç»“æ„é‡æ„

#### 1.1 æ·»åŠ  `user_email` å­—æ®µ
åœ¨ `init_db()` å‡½æ•°ä¸­ï¼Œå·²ä¿®æ”¹ `invoices` è¡¨ç»“æ„ï¼š

```python
cursor.execute('''CREATE TABLE IF NOT EXISTS invoices
                (id INTEGER PRIMARY KEY AUTOINCREMENT, 
                user_email TEXT NOT NULL,  # æ–°å¢ï¼šç”¨æˆ·é‚®ç®±å­—æ®µ
                user_id TEXT DEFAULT 'default_user', 
                file_name TEXT, date TEXT, invoice_number TEXT, 
                seller_name TEXT, seller_ubn TEXT,
                subtotal REAL, tax REAL, total REAL, 
                category TEXT, subject TEXT, status TEXT,
                image_path TEXT, image_data BLOB,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
```

#### 1.2 å»ºç«‹ç´¢å¼•
ä¸ºæé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä¸º `user_email` å»ºç«‹äº†ç´¢å¼•ï¼š

```python
cursor.execute('''CREATE INDEX IF NOT EXISTS idx_user_email ON invoices(user_email)''')
```

#### 1.3 å‘åå…¼å®¹
é€šè¿‡ `ALTER TABLE` è¯­å¥ï¼Œç¡®ä¿æ—§æ•°æ®åº“ä¹Ÿèƒ½è‡ªåŠ¨æ·»åŠ æ–°å­—æ®µï¼š

```python
for col, c_type in {'user_email': "TEXT", ...}.items():
    try: 
        cursor.execute(f"ALTER TABLE invoices ADD COLUMN {col} {c_type}")
    except: 
        pass  # å­—æ®µå·²å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
```

---

### 2. ç™»å½•ä¸ Session ç®¡ç†

#### 2.1 Session State åˆå§‹åŒ–
```python
if "authenticated" not in st.session_state: 
    st.session_state.authenticated = False
if "user_email" not in st.session_state: 
    st.session_state.user_email = None
```

#### 2.2 ç”¨æˆ·éªŒè¯å‡½æ•° `verify_user(email, password)`
æ”¯æŒä¸‰ç§é…ç½®æ–¹å¼ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
1. **Streamlit Secrets** (`st.secrets["USERS"]`)
   - å­—å…¸æ ¼å¼ï¼š`{"user@example.com": "password", ...}`
   - å­—ç¬¦ä¸²æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ª `email:password`
2. **ç¯å¢ƒå˜é‡** (`os.getenv("USERS")`)
   - å­—ç¬¦ä¸²æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ª `email:password`
3. **é»˜è®¤ç”¨æˆ·**ï¼ˆå¼€å‘/æµ‹è¯•ç”¨ï¼‰
   ```python
   DEFAULT_USERS = {
       "admin@example.com": "admin123",
       "test@example.com": "test123"
   }
   ```

#### 2.3 ç™»å½•é¡µé¢ `login_page()`
- é‚®ç®±è¾“å…¥æ¡†ï¼ˆå¸¦æ ¼å¼éªŒè¯ï¼‰
- å¯†ç è¾“å…¥æ¡†ï¼ˆéšè—æ˜¾ç¤ºï¼‰
- ç™»å½•æŒ‰é’®å’Œåˆ·æ–°æŒ‰é’®
- æ·±è‰²ä¸»é¢˜ UIï¼Œä¸åº”ç”¨æ•´ä½“é£æ ¼ä¸€è‡´

#### 2.4 ç™»å½•æ£€æŸ¥
åœ¨ä¸»åº”ç”¨å…¥å£å¤„ï¼š
```python
if not st.session_state.authenticated or not st.session_state.user_email:
    login_page()
    st.stop()  # æœªç™»å½•æ—¶åœæ­¢æ‰§è¡Œåç»­ä»£ç 
```

#### 2.5 ç™»å‡ºåŠŸèƒ½
åœ¨ä¾§è¾¹æ æ˜¾ç¤ºå½“å‰ç”¨æˆ·å¹¶æä¾›ç™»å‡ºæŒ‰é’®ï¼š
```python
if st.session_state.user_email:
    st.success(f"ğŸ‘¤ ç•¶å‰ç”¨æˆ¶: {st.session_state.user_email}")

if st.button("ğŸšª ç™»å‡º"):
    st.session_state.authenticated = False
    st.session_state.user_email = None
    st.rerun()
```

---

### 3. æ•°æ®ç­›é€‰éš”ç¦»ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

#### 3.1 `run_query()` å‡½æ•°å¢å¼º
å‡½æ•°ç­¾åå·²æ›´æ–°ï¼š
```python
def run_query(query, params=(), is_select=True, user_email=None):
    """
    æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼ˆå¤šç”¨æˆ·ç‰ˆæœ¬ï¼šè‡ªåŠ¨æ·»åŠ ç”¨æˆ·éš”ç¦»ï¼‰
    
    Args:
        user_email: å½“å‰ç”¨æˆ·é‚®ç®±ï¼ˆå¦‚æœä¸º Noneï¼Œä» session_state è·å–ï¼‰
    """
```

#### 3.2 SELECT æŸ¥è¯¢è‡ªåŠ¨éš”ç¦»
**å†…å­˜æ¨¡å¼**ï¼š
```python
if is_select:
    all_invoices = st.session_state.local_invoices
    # è‡ªåŠ¨è¿‡æ»¤å½“å‰ç”¨æˆ·çš„æ•°æ®
    if user_email:
        user_invoices = [inv for inv in all_invoices 
                       if inv.get('user_email') == user_email]
    df = pd.DataFrame(user_invoices)
```

**æ•°æ®åº“æ¨¡å¼**ï¼š
- è‡ªåŠ¨æ£€æµ‹æŸ¥è¯¢æ˜¯å¦åŒ…å« `user_email` æ¡ä»¶
- å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨æ·»åŠ  `WHERE user_email = ?` æˆ– `AND user_email = ?`
- è‡ªåŠ¨å¤„ç† `ORDER BY`ã€`LIMIT` ç­‰å­å¥çš„ä½ç½®

```python
# æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦å·²ç»åŒ…å« user_email æ¡ä»¶
has_user_filter = 'USER_EMAIL' in query_upper or 'user_email' in query

if not has_user_filter and 'FROM invoices' in query_upper and user_email:
    if 'WHERE' in query_upper:
        # åœ¨ç°æœ‰ WHERE æ¡ä»¶åæ·»åŠ  AND user_email = ?
        modified_query = query[:end_pos] + f" AND user_email = ?" + query[end_pos:]
    else:
        # æ·»åŠ  WHERE user_email = ?
        modified_query = query + f" WHERE user_email = ?"
    modified_params.append(user_email)
```

#### 3.3 INSERT è¯­å¥è‡ªåŠ¨æ·»åŠ  user_email
åœ¨ `run_query()` çš„ INSERT å¤„ç†ä¸­ï¼š
```python
if "INSERT INTO invoices" in query.upper() and user_email:
    if 'user_email' not in query.upper():
        # åœ¨åˆ—ååˆ—è¡¨çš„ç¬¬ä¸€å€‹ä½ç½®æ’å…¥ user_email
        modified_query = query[:col_start+1] + f"user_email, {cols}" + query[col_end:]
        # åœ¨åƒæ•¸åˆ—è¡¨é–‹é ­æ·»åŠ  user_email
        modified_params.insert(0, user_email)
```

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### é…ç½®ç”¨æˆ·ï¼ˆä¸‰ç§æ–¹å¼ï¼‰

#### æ–¹å¼ 1ï¼šStreamlit Secretsï¼ˆæ¨èï¼‰
åœ¨ `.streamlit/secrets.toml` æ–‡ä»¶ä¸­ï¼š

```toml
# æ–¹å¼ Aï¼šå­—å…¸æ ¼å¼
[USERS]
"admin@example.com" = "admin123"
"user@example.com" = "user123"

# æ–¹å¼ Bï¼šå­—ç¬¦ä¸²æ ¼å¼ï¼ˆæ¯è¡Œä¸€ä¸ª email:passwordï¼‰
USERS = """
admin@example.com:admin123
user@example.com:user123
"""
```

#### æ–¹å¼ 2ï¼šç¯å¢ƒå˜é‡
```bash
# Windows PowerShell
$env:USERS="admin@example.com:admin123`nuser@example.com:user123"

# Linux/Mac
export USERS="admin@example.com:admin123
user@example.com:user123"
```

#### æ–¹å¼ 3ï¼šä½¿ç”¨é»˜è®¤ç”¨æˆ·ï¼ˆä»…å¼€å‘/æµ‹è¯•ï¼‰
ä»£ç ä¸­å·²å†…ç½®ï¼š
- `admin@example.com` / `admin123`
- `test@example.com` / `test123`

---

## ğŸ”’ å®‰å…¨ç‰¹æ€§

1. **è‡ªåŠ¨æ•°æ®éš”ç¦»**ï¼šæ‰€æœ‰ SELECT æŸ¥è¯¢è‡ªåŠ¨æ·»åŠ ç”¨æˆ·è¿‡æ»¤æ¡ä»¶
2. **è‡ªåŠ¨æ•°æ®å½’å±**ï¼šæ‰€æœ‰ INSERT æ“ä½œè‡ªåŠ¨æ·»åŠ å½“å‰ç”¨æˆ·çš„ `user_email`
3. **ç™»å½•éªŒè¯**ï¼šåªæœ‰é€šè¿‡éªŒè¯çš„ç”¨æˆ·æ‰èƒ½è®¿é—®ç³»ç»Ÿ
4. **Session ç®¡ç†**ï¼šç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ `st.session_state` ä¸­

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ—§æ•°æ®è¿ç§»**ï¼šå¦‚æœæ•°æ®åº“å·²æœ‰æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨ä¸ºæ—§æ•°æ®æ·»åŠ  `user_email` å­—æ®µå€¼
2. **å¯¼å‡ºåŠŸèƒ½**ï¼šå¯¼å‡ºåŠŸèƒ½ï¼ˆCSV/PDFï¼‰éœ€è¦ç¡®ä¿åªå¯¼å‡ºå½“å‰ç”¨æˆ·çš„æ•°æ®ï¼ˆå¾…å®ç°ï¼‰
3. **UPDATE/DELETE å®‰å…¨**ï¼šå»ºè®®åœ¨ UPDATE/DELETE æ“ä½œä¸­æ˜¾å¼æ·»åŠ  `user_email` æ¡ä»¶ï¼Œç¡®ä¿ä¸ä¼šè¯¯æ“ä½œå…¶ä»–ç”¨æˆ·çš„æ•°æ®

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… æ•°æ®åº“ç»“æ„é‡æ„ - **å·²å®Œæˆ**
2. âœ… ç™»å½•é€»è¾‘ - **å·²å®Œæˆ**
3. âœ… æ•°æ®è¯»å–éš”ç¦» - **å·²å®Œæˆ**
4. â³ ä¿®æ”¹æ‰€æœ‰ INSERT è¯­å¥è°ƒç”¨ï¼ˆç¡®ä¿æ­£ç¡®ä¼ é€’ user_emailï¼‰
5. â³ å¯¼å‡ºåŠŸèƒ½éš”ç¦»ï¼ˆCSV/PDF åªå¯¼å‡ºå½“å‰ç”¨æˆ·æ•°æ®ï¼‰
6. â³ UPDATE/DELETE æ“ä½œçš„ç”¨æˆ·éš”ç¦»éªŒè¯
