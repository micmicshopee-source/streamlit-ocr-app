# 上架前測試與檢查報告

**角色**：項目總經理  
**日期**：2026-02-07  
**應用**：上班族小工具（發票報帳・辦公小幫手）  
**主程式**：`app.py`

---

## 一、檢查摘要

| 類別         | 結果 | 說明 |
|--------------|------|------|
| 代碼語法     | ✅ 通過 | `app.py` 語法檢查無誤 |
| 安全與登入   | ✅ 合格 | 無測試帳號、密碼雜湊、Session 過期、登入鎖定、多用戶隔離 |
| SQL 與資料庫 | ✅ 合格 | 查詢均使用參數化，無字串拼接；user_email 隔離完整 |
| 搜尋與邊界   | ✅ 已改善 | 搜尋使用 `_safe_search_val` 處理 None/NaN，無誤匹配 |
| 模板與內容   | ⚠️ 注意 | `templates/invoice_pdf.html` 未被主程式引用（見下文） |
| 依賴         | ⚠️ 建議 | `bcrypt` 未在 requirements.txt，生產環境可選加入 |

---

## 二、邏輯與內容檢查

### 2.1 登入與權限

- **登入/註冊/忘記密碼**：流程完整，台灣用語一致（登入、電子郵件、密碼）。
- **Session 過期**：AUTH-04 已實作，`_SESSION_EXPIRE_HOURS = 24`，逾時後自動登出。
- **登入失敗鎖定**：AUTH-03 已實作（`login_attempts` 表、`is_login_locked`）。
- **CSRF**：登入頁使用 `login_csrf_token`（session 內 token）。
- **多用戶隔離**：`run_query` 對 `invoices` 自動加上 `user_email` 條件；INSERT/UPDATE/DELETE 均帶入當前用戶。
- **無測試帳號**：程式內無默認測試帳號，註冊或 Secrets 配置方可登入。

### 2.2 資料庫與 SQL

- **參數化查詢**：未發現 `execute(..., %s)` 或字串拼接；均使用 `?` 與 `params`。
- **ALTER TABLE**：僅對固定欄位名（如 `line_id`, `facebook_id`, `modified_at`）使用 f-string，非用戶輸入，風險可接受。
- **init_db**：建立 `users`、`login_attempts`、`invoices`、`batches` 表及索引；缺少欄位會自動補齊。

### 2.3 OCR 與發票流程

- **OCR 重試**：Bug #5 已修，使用 `requests` Retry（429/5xx，最多 3 次）。
- **單張失敗不中斷**：單張 OCR 失敗時 `continue`，不影響同批其他張寫入。
- **重複偵測**：`check_duplicate_invoice(invoice_no, invoice_date, user_email)`，重複則跳過並提示。
- **寫入失敗降級**：資料庫寫入失敗時會嘗試寫入內存並切換 `use_memory_mode`，並有明確錯誤訊息。

### 2.4 搜尋與篩選

- **搜尋空值**：使用 `_safe_search_val(val)`，對 `None` 與 `pd.isna(val)` 回傳 `""`，再參與 `" ".join(parts).lower()`，避免搜尋 "no" 誤匹配 `"None"`。
- **篩選**：依「發票號碼、賣方名稱、檔案名稱」搜尋；狀態篩選（全部/正常/缺漏）與主流程一致。

### 2.5 導出與 PDF

- **CSV/Excel**：依當前篩選與登入用戶導出，欄位與國稅局結構對齊。
- **PDF**：使用 `fpdf2`（FPDF）在程式內直接生成報表（公司名稱、統編、統計摘要、明細表），未使用 `templates/invoice_pdf.html`。
- **templates/invoice_pdf.html**：內含 `{{INVOICE_NUMBER}}`、`{{TABLE_ROWS}}`、`{{ISSUER_HTML}}` 等占位符，目前**未被任何 .py 引用**。若為歷史或規劃用模板，不影響上架；若計劃用於「單張發票 PDF」，需在程式中接上並傳入對應變數。

### 2.6 發票模板內容（invoice_pdf.html）

- **語言與排版**：繁體中文 + 英文並列（發票、Invoice、發行方 Issuer、接收方 Bill To 等），版型清楚。
- **字型**：`NotoSansTC-Regular.ttf`，需確保運行時可載入（路徑或嵌入）。
- **占位符**：`INVOICE_NUMBER`、`DATE`、`DUE_DATE`、`ISSUER_HTML`、`RECEIVER_HTML`、`TABLE_ROWS`、`SUBTOTAL`、`VAT`、`TOTAL` 需由後端填入；目前主程式未使用此模板。

---

## 三、上架前建議動作

### 必須（上架前完成）

1. **實際跑一輪主流程**  
   - 註冊 → 登入 → 上傳圖片 OCR → 檢視/編輯/刪除 → 導出 CSV/Excel/PDF → 登出。  
   - 確認 Session 逾時（可暫時改 `_SESSION_EXPIRE_HOURS` 為 0.001 做快速測試）。

2. **確認環境變數/Secrets**  
   - 生產環境設定 `GEMINI_API_KEY`（或透過 Streamlit Secrets）。  
   - 若使用 Google/LINE/Facebook 登入，設定對應 `*_CLIENT_ID`、`*_SECRET`、`OAUTH_REDIRECT_URI`。

3. **確認 .gitignore**  
   - 已含 `.streamlit/secrets.toml`、`*.db`、`invoice_images/`，避免敏感與本地資料上傳。

### 建議（短期）

1. **bcrypt（AUTH-01）**  
   - 程式已支援 bcrypt，未安裝時退回 SHA256。若部署環境可編譯 C 擴展，建議在 `requirements.txt` 加入 `bcrypt>=4.0.0`，以符合「安全雜湊」需求。

2. **templates/invoice_pdf.html**  
   - 若未來要做「單張發票 PDF」下載，可在 app.py 中讀取此模板並替換占位符；否則可標註為「備用/規劃」或移至 doc/ 避免誤解為現用。

3. **統編與稅率**  
   - 審計報告已指出：統編無 8 位數驗證、稅率目前固定 5%。若產品需要，可之後加上統編格式檢查與稅率類型（0%/免稅）欄位。

---

## 四、功能清單勾選（對照上線準備清單）

- [x] 無測試帳號、無調試模式開關、無測試數據
- [x] 註冊、登入、忘記密碼、登出
- [x] 多用戶資料隔離（user_email）
- [x] OCR 辨識（含重試）、重複發票偵測
- [x] 發票列表、篩選、搜尋、編輯、刪除（含確認）
- [x] 導出 CSV、Excel、PDF（fpdf2）
- [x] 圖表與統計、公司資訊（PDF 用）
- [x] Session 24 小時過期、登入失敗鎖定
- [x] 密碼強度檢核、密碼雜湊（bcrypt 或 SHA256）
- [x] SQL 參數化、無注入風險

---

## 五、結論

- **邏輯與內容**：主流程、權限、資料隔離、錯誤處理與既有審計結論一致，無發現阻擋上架的邏輯錯誤。
- **內容**：介面為台灣用語，發票模板 `invoice_pdf.html` 文案正確，但當前未接上主程式，不影響現有上架功能。
- **建議**：完成上述「必須」三項後即可上架；其餘為文檔與後續優化（bcrypt、模板接軌、統編/稅率）。

**上架結論**：✅ **在完成「三、上架前建議動作」中必須項後，可安排上架。**

---

**報告版本**：v1.0  
**審查基準**：app.py（全檔）、requirements.txt、templates/invoice_pdf.html、上線準備清單_20260126.md、全系統功能邏輯審計報告_System_Audit.md
