# 上班族小工具 — 現況與方案整理

本文整理**目前專案使用的技術與設定**，以及**部署與持久化方案**，方便你一眼看清現況與可選做法。

---

## 一、目前你用的（現況）

### 1.1 部署方式

| 項目 | 現況 |
|------|------|
| **運行環境** | **Streamlit Community Cloud**（方案 A） |
| **網址** | `https://你的app名.streamlit.app` |
| **特點** | 免費、一鍵部署、內建 HTTPS；**會休眠、本機資料會清空** |

### 1.2 技術與依賴

| 項目 | 現況 |
|------|------|
| **主程式** | `app.py`（Streamlit） |
| **資料庫** | **SQLite**（`invoices_v2.db`，存在應用目錄；Cloud 上為臨時磁碟，休眠後清空） |
| **圖片儲存** | 本機目錄 `invoice_images/`（同上，休眠後清空） |
| **登入方式** | 本站註冊（信箱+密碼）、Google、LINE、Facebook（OAuth） |
| **AI 辨識** | Google Gemini API（需 `GEMINI_API_KEY`） |
| **Session** | 登入狀態存在 Streamlit `session_state`（記憶體），刷新或休眠後需重新登入 |

### 1.3 Secrets / 環境變數（目前程式會讀的）

程式從 **Streamlit Secrets**（或環境變數）讀取以下內容，格式為 TOML（在 Cloud：App → Settings → Secrets）：

| 用途 | 區塊/鍵名 | 必填 | 說明 |
|------|------------|------|------|
| **Gemini** | 頂層 `GEMINI_API_KEY` | 是（發票辨識） | Google AI API 金鑰 |
| **Google 登入** | `[google_auth]` | 否 | `client_id`、`client_secret`、`redirect_uri`；或頂層 `GOOGLE_CLIENT_ID` / `GOOGLE_CLIENT_SECRET` |
| **LINE 登入** | `[line_auth]` | 否 | `channel_id`、`channel_secret`、`callback_url`；或 `[line]` 或頂層 `LINE_CHANNEL_ID` / `LINE_CHANNEL_SECRET` |
| **Facebook 登入** | 頂層 `FACEBOOK_APP_ID`、`FACEBOOK_APP_SECRET` | 否 | 若未設，Facebook 按鈕會顯示未設定 |
| **OAuth 回調** | 頂層 `OAUTH_REDIRECT_URI` 或環境變數 | 否 | 未設時由 Streamlit 依環境推斷（本機 / Cloud） |
| **邀請碼** | 頂層 `INVITATION_CODE` 或 `INVITATION_CODES` | 否 | 有設定則註冊時必填邀請碼 |

**Secrets 範例（與你目前格式一致）：**

```toml
GEMINI_API_KEY = "你的 Gemini 金鑰"

[google_auth]
client_id = "你的 Google Client ID"
client_secret = "你的 Google Client Secret"
redirect_uri = "https://你的app名.streamlit.app/"

[line_auth]
channel_id = "你的 Channel ID"
channel_secret = "你的 Channel Secret"
callback_url = "https://你的app名.streamlit.app/"
```

### 1.4 側邊欄與頁面

| 項目 | 現況 |
|------|------|
| **法律條款** | 側邊欄單選：主程式 / 隱私政策 / 服務條款 |
| **小工具** | 發票報帳小秘笈、AI 合約比對、AI 客服小秘、AI 會議精華、🛡️ Google 登錄診斷工具 |
| **多頁** | `pages/1_🛡️_Google登錄診斷工具.py`（診斷工具也可從側邊欄進入） |

### 1.5 已知限制（方案 A）

- **休眠**：長時間無人訪問會關掉應用，再開時冷啟動。
- **資料不持久**：SQLite、`invoice_images`、註冊帳號在休眠/重啟後清空。
- **刷新可能掉登入**：Session 在記憶體，重啟或換實例會要求重新登入。

---

## 二、方案對照（你要怎麼選）

### 2.1 一句話對照

| 方案 | 一句話 | 適合 |
|------|--------|------|
| **方案 A（你現在用的）** | Streamlit Cloud 免費版，會休眠、本機資料會清空。 | 展示、試用、小流量 |
| **方案 B** | 自己的 VPS + Docker + Nginx，資料寫在掛載磁碟，持久保存。 | **正式給用戶用、要長期保存資料** |

### 2.2 詳細對照

| 項目 | 方案 A（Streamlit Cloud） | 方案 B（VPS + Docker） |
|------|---------------------------|-------------------------|
| **網址** | `xxx.streamlit.app` 或自訂域名 CNAME | 自有域名（如 `https://your-domain.com`） |
| **休眠** | 會休眠 | 不會（自己控機） |
| **註冊/發票資料** | 休眠後清空 | 持久保存（掛載卷） |
| **登入狀態** | 刷新/休眠後可能掉登入 | 同一般網站（Session 依 Cookie/伺服器） |
| **成本** | 免費 | VPS 月費（依廠商） |
| **維運** | 幾乎不用管 | 需管伺服器、更新、備份 |
| **Secrets** | App → Settings → Secrets（TOML） | `.streamlit/secrets.toml` 或 `.env` 掛載進容器 |

### 2.3 建議選擇

- **繼續用方案 A**：當成展示/試用，接受休眠與資料清空；登入頁已有提示。
- **要正式上線、資料不能丟**：改用 **方案 B**，依 `部署上線方案.md` 用 VPS + Docker + Nginx 部署，資料庫與圖片用掛載卷。

---

## 三、檔案對照（文件與設定）

| 檔案 | 用途 |
|------|------|
| **部署上線方案.md** | 方案 A / B 步驟、Nginx、SSL、Secrets 範例、休眠說明、資料持久化 |
| **現況與方案整理.md** | 本文件：現況整理 + 方案對照 |
| **docker-compose.yml** | 本機/簡單部署用（埠 8501） |
| **docker-compose.prod.yml** | 生產用（僅本機 8501，配合 Nginx） |
| **Dockerfile** | 建映像用（含 `templates/`、`pages/`） |
| **.streamlit/secrets.toml** | 本機 Secrets（勿提交 Git）；Cloud 上在後台填 |

---

## 四、快速檢查清單（方案 A 現況）

- [ ] **GEMINI_API_KEY** 已在 Secrets 設定（發票辨識才可用）
- [ ] **Google 登入**：`[google_auth]` 的 `client_id`、`client_secret`、`redirect_uri` 與 Google 後台一致
- [ ] **LINE 登入**：`[line_auth]` 的 `channel_id`、`channel_secret`、`callback_url` 與 LINE 後台一致
- [ ] 了解：**休眠後資料會清空**，要長期保存請改用方案 B（見 `部署上線方案.md`）

---

## 五、若你要改成方案 B（VPS）

1. 準備 VPS、域名，並把域名指到 VPS。
2. 在伺服器裝 Docker、Docker Compose、Nginx、Certbot。
3. Clone 專案，建立 `data/`、`invoice_images/`、`.streamlit/secrets.toml`（或 `.env`）。
4. 執行：`docker compose -f docker-compose.prod.yml up -d --build`。
5. 設定 Nginx 反向代理與 SSL（`certbot --nginx`）。
6. 在 Google / LINE 後台把授權回調改為 `https://你的域名/`。

詳細指令與範例都在 **`部署上線方案.md`** 第三節（方案 B）。
