# 發票模組 — 時間篩選條件邏輯

**預設**：全部（不依日期篩選）  
**參考 UI**：左側快捷選項 + 右側自訂區間（雙日曆選開始／結束日）

---

## 一、選項與對應日期區間

| 選項 | 說明 | `date_range_start` | `date_range_end` | 備註 |
|------|------|--------------------|------------------|------|
| **全部** | 不依日期篩選 | `None` | `None` | 預設值，查詢不套用日期條件 |
| **今天** | 當日 | `today` | `today` | 同一天 |
| **昨天** | 前一日 | `today - 1 day` | `today - 1 day` | 同一天 |
| **過去一週** | 最近 7 天（含今天） | `today - 6 days` | `today` | 共 7 天 |
| **過去一個月** | 最近約 30 天（含今天） | `today - 29 days` | `today` | 共 30 天 |
| **近三個月** | 最近約 90 天（含今天） | `today - 89 days` | `today` | 共 90 天 |
| **自訂區間** | 使用者自選起訖日 | 使用者選的開始日 | 使用者選的結束日 | 需顯示日期選擇器（雙日曆或開始／結束） |

- 以上 `today` 皆以 **伺服器／執行環境的當前日期** 為準（`datetime.now().date()`）。
- 篩選時只保留 `發票日期 >= date_range_start` 且 `發票日期 <= date_range_end` 的資料；當兩者皆為 `None`（全部）時，不套用日期條件。

---

## 二、狀態與 UI 行為

### 2.1 預設狀態

- **當前選項**：`全部`
- **session / 狀態**：`time_filter = "全部"`，`date_range_start = None`，`date_range_end = None`
- **右側**：不需顯示日期選擇器（或可隱藏／停用）。

### 2.2 左側：快捷選項（單選）

- 選項列表：**全部**、今天、昨天、過去一週、過去一個月、近三個月、（可選）**自訂區間**。
- 行為：
  - 點選「全部」→ 設 `time_filter = "全部"`，`date_range_start` / `date_range_end` 設為 `None`；右側日期選擇器可隱藏。
  - 點選「今天」「昨天」「過去一週」「過去一個月」「近三個月」→ 設 `time_filter` 為該選項，並依上表寫入 `date_range_start`、`date_range_end`；右側可顯示唯讀摘要（例如「2026/1/23–2026/1/29」）或隱藏選擇器。
  - 點選「自訂區間」→ 設 `time_filter = "自訂區間"`；若尚未有選過日期，可預設 `date_range_start = date_range_end = today`；**右側顯示日期選擇器**（雙日曆或開始／結束兩個欄位），由使用者選開始日與結束日，寫回 `date_range_start`、`date_range_end`。

### 2.3 右側：自訂區間日期選擇

- **顯示時機**：僅當 `time_filter == "自訂區間"` 時顯示。
- **互動**：
  - 需能選擇 **開始日期**、**結束日期**。
  - 若框架支援雙日曆（一次選區間），則用同一元件；否則用兩個欄位（開始日、結束日）。
- **驗證**：`date_range_start <= date_range_end`；若使用者選反了，可自動對調或提示錯誤。
- **與左側同步**：使用者在右側改動開始／結束日後，仍視為「自訂區間」；左側當前選項應維持「自訂區間」，不再自動改回「今天」等。

---

## 三、後端篩選邏輯（偽代碼）

```text
取得 time_filter、date_range_start、date_range_end

若 time_filter == "全部" 或 (date_range_start 為空 且 date_range_end 為空):
    不套用日期篩選，保留所有發票
否則:
    若 date_range_start 或 date_range_end 為空:
        以 today 補齊（或視為全部，依產品決定）
    將發票的「日期」欄位正規化為 date 類型
    保留 日期 >= date_range_start 且 日期 <= date_range_end 的資料
```

- 發票日期若為字串（如 `%Y/%m/%d`、`%Y-%m-%d`），需先轉成 `date` 再比較。
- 若只選了「自訂區間」但尚未選日期，可約定：未選則不篩選（等同全部），或預設 start=end=today。

---

## 四、與現有程式的對應

- **目前**：`time_filter_options = ["全部", "本日", "本週", "本月", "最近 30 天", "自訂區間"]`，用 `st.selectbox`。
- **改為新邏輯後**：
  - 快捷選項改為：**全部**、今天、昨天、過去一週、過去一個月、近三個月、自訂區間。
  - 對應關係：
    - 全部 → 同上。
    - 今天 → 同「本日」。
    - 昨天 → 新增（start = end = today - 1 day）。
    - 過去一週 → 類似「本週」但可改為固定 7 天（start = today - 6, end = today）。
    - 過去一個月 → 同「最近 30 天」（start = today - 29, end = today）。
    - 近三個月 → 新增（start = today - 89, end = today）。
    - 自訂區間 → 維持現有兩個 `st.date_input`（開始／結束）或未來換成雙日曆元件。
  - **預設**：`time_filter = "全部"`，`date_range_start` / `date_range_end` = `None`。
  - UI 可改為 **左側 radio / pills 快捷選項**，**右側僅在「自訂區間」時顯示日期選擇器**，以貼近你提供的介面。

---

## 五、小結

- **預設**：全部（不篩選日期）。
- **快捷選項**：全部、今天、昨天、過去一週、過去一個月、近三個月、自訂區間；每個選項對應一組 `(date_range_start, date_range_end)`。
- **自訂區間**：僅在此選項時顯示開始／結束日期選擇；選完後仍為自訂區間，由後端依 `date_range_start`、`date_range_end` 篩選。
- **後端**：僅當非「全部」且起訖日存在時，依區間過濾發票日期。

此邏輯可直接用來實作或調整現有發票時間篩選程式碼。
