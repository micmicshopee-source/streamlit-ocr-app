# 發票模組 — 時間篩選條件邏輯（依參考圖重寫）

**預設**：全部（不依日期篩選）  
**參考**：單一「日期範圍」元件，**打開時**左側為快捷選項、右側為雙日曆選自訂區間；自定義時間 = 在右側日曆裡選開始／結束日，左側列表沒有「自訂區間」這一項。

---

## 一、介面結構（與圖片一致）

- **觸發方式**：一個「時間範圍」或「選擇日期」的觸發區（例如按鈕／輸入框），點擊後**打開**日期選擇元件。
- **打開後的版面**：
  - **左側**：垂直列表，僅 6 個選項（單選）  
    **全部**、**今天**、**昨天**、**過去一週**、**過去一個月**、**近三個月**。  
    → 左側**沒有**「自訂區間」或「自定義」選項。
  - **右側**：雙月曆（或兩個月曆並排），用來選 **開始日期** 與 **結束日期**。  
    → 在右側日曆裡選日期 = **自定義時間**（自訂區間）。不需要在左邊多一個「自訂區間」條目。
- **預設**：未選時 = **全部**；觸發區可顯示「全部」或「選擇日期範圍」。

---

## 二、選項與對應邏輯

### 2.1 左側 6 個快捷選項（對應日期區間）

| 左側選項 | 說明 | `date_range_start` | `date_range_end` |
|----------|------|--------------------|------------------|
| **全部** | 不依日期篩選 | `None` | `None` |
| **今天** | 當日 | `today` | `today` |
| **昨天** | 前一日 | `today - 1 day` | `today - 1 day` |
| **過去一週** | 最近 7 天（含今天） | `today - 6 days` | `today` |
| **過去一個月** | 最近 30 天（含今天） | `today - 29 days` | `today` |
| **近三個月** | 最近 90 天（含今天） | `today - 89 days` | `today` |

- `today` = 伺服器當前日期 `datetime.now().date()`。
- 點選左側任一項 → 直接套用上表區間，**不需**在右側日曆再選。

### 2.2 右側日曆 = 自定義時間

- 使用者在**右側雙日曆**中選定「開始日」與「結束日」→ 即為 **自定義時間**（自訂區間）。
- 寫入：`date_range_start` = 選的開始日，`date_range_end` = 選的結束日。
- 此時可視為一種「自訂區間」狀態（例如用 `time_filter = "自訂區間"` 或依 `date_range_start/end` 是否有自訂值判斷），**左側列表仍只有上述 6 項**，不會多出「自訂區間」一欄。
- 驗證：若開始日 > 結束日，可自動對調或提示。

---

## 三、狀態與行為整理

- **預設**：`time_filter = "全部"`，`date_range_start = None`，`date_range_end = None`。
- **點左側「全部」**：設為全部，清空起訖日；右側日曆可保留上次選擇僅供檢視，但篩選以「全部」為準。
- **點左側「今天」～「近三個月」**：依上表設 `date_range_start`、`date_range_end`；篩選依此區間。
- **在右側日曆選開始／結束日**：視為自定義時間；寫入 `date_range_start`、`date_range_end`，篩選依此區間；左側可維持不選或顯示為「自訂」提示（依實作而定），但左側列表仍只有 6 項。
- **後端**：只要 `date_range_start`、`date_range_end` 都有值就依區間篩選；兩者皆為 `None` 則不套用日期條件（全部）。

---

## 四、後端篩選邏輯（偽代碼）

```text
取得 date_range_start、date_range_end

若 date_range_start 為空 且 date_range_end 為空:
    不套用日期篩選（全部）
否則:
    若有任一方為空則可補齊或視為全部（依產品約定）
    將發票「日期」欄位轉為 date
    保留 日期 >= date_range_start 且 日期 <= date_range_end 的資料
```

- 發票日期若為字串，需先轉成 `date` 再比較。

---

## 五、與 Streamlit 的對應（實作要點）

- Streamlit 沒有內建「打開後左 6 項 + 右雙日曆」的單一元件，可用以下方式逼近：
  1. **用 expander 模擬「打開」**：標題為「時間範圍」或「選擇日期範圍」，預設收合；`expanded=True` 時等同「打開」。
  2. **Expander 內兩欄**：
     - **左欄**：`st.radio` 或垂直按鈕，選項**僅**：全部、今天、昨天、過去一週、過去一個月、近三個月。
     - **右欄**：兩個 `st.date_input`（開始日期、結束日期）或一組雙月曆元件。
  3. **邏輯**：
     - 選左側任一項 → 依上表設起訖日（全部則設為 None）。
     - 使用者改動右側開始／結束日 → 視為自定義時間，寫入 `date_range_start`、`date_range_end`；左側可不清選，但篩選以右側為準（或左側不選任何一項時就視為自訂）。
  4. **觸發區顯示**：可在 expander 外顯示目前狀態，例如「全部」或「2026/1/1–2026/1/29」（自訂時）。

如此即為：**打開日期時，左邊只有 全部／今天／昨天／過去一週／過去一個月／近三個月，自定義時間就是在右邊日曆裡選**，與參考圖一致。
